{"code":"!function(e){var t={};function r(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var a in e)r.d(n,a,function(t){return e[t]}.bind(null,a));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,\"a\",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p=\"build/\",r(r.s=40)}([function(e,t){e.exports=require(\"@babel/runtime/regenerator\")},function(e,t){e.exports=require(\"@hapi/joi\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/asyncToGenerator\")},function(e,t,r){\"use strict\";var n=r(10),a=r(17),s=r.n(a),i=r(13),o=r.n(i),u=r(4),c=n.format.combine,l=n.format.timestamp,d=n.format.label,p=n.format.simple,f=n.format.printf,h=n.format.colorize;o.a.existsSync(\"logs\")||o.a.mkdirSync(\"logs\");var m=Object(n.createLogger)({level:\"info\",format:c(d({label:u.a.app_name}),l({format:\"YYYY-MM-DD HH:mm:ss\"}),p(),f((function(e){var t=e.padding&&e.padding[e.level]||\"\";return\"\".concat(e.timestamp,\" [\").concat(e.label,\"] \").concat(e.level,\":\").concat(t,\" \").concat(e.message)})),h()),transports:[new s.a({filename:\"logs/error.log\",level:\"error\"}),new s.a({filename:\"logs/info.log\",level:\"info\"})]});t.a=m},function(e,t,r){\"use strict\";var n=r(30);r.n(n).a.config(),t.a={app_name:process.env.APP_NAME||\"App\",env_mode:process.env.ENVIRONMENT,hostname:process.env.HOST||\"localhost\",port:parseInt(process.env.PORT)||4e3,db_host:process.env.DB_HOST,db_port:process.env.DB_PORT,db_name:process.env.DB_NAME,db_user:process.env.DB_USER,db_pass:process.env.DB_PASS,db_dialect:process.env.DB_DIALECT,ssl:\"production\"==process.env.ENVIRONMENT&&process.env.SSL,mail_sender_name:process.env.MAIL_SENDER_NAME||\"\",mail_sender_email:process.env.MAIL_SENDER_EMAIL||\"\",mail_sender_password:process.env.MAIL_SENDER_PASSWORD||\"\",confirm_mail_subject:process.env.CONFIRM_MAIL_SUBJECT||\"PLEASE CONFIRM YOUR EMAIL\",reset_password_mail_subject:process.env.RESET_PASSWORD_MAIL_SUBJECT||\"RESET PASSWORD\",redis_host:process.env.REDIS_HOST,redis_port:process.env.REDIS_PORT,redis_pass:process.env.REDIS_PASS,secret_key:process.env.SECRET_KEY||\"\",token_expiresin:process.env.TOKEN_EXPIRESIN||\"30m\",refresh_token_expiresin:process.env.REFRESH_TOKEN_EXPIRESIN||\"12h\",server_root_url:process.env.SERVER_ROOT_URL||\"\",web_root_url:process.env.WEB_ROOT_URL||\"\",activation_code_digit:parseInt(process.env.ACTIVATION_CODE_DIGIT)||6,activation_code_expiresin:parseInt(process.env.ACTIVATION_CODE_EXPIRESIN)||86400,activation_link_url:process.env.ACTIVATION_LINK_URL||\"activate\",reset_password_link_url:process.env.RESET_PASSWORD_LINK_URL||\"resetpassword\",company_name:process.env.COMPANY_NAME||\"\",aws_access_key_id:process.env.AWS_ACCESS_KEY_ID||\"\",aws_secret_access_key:process.AWS_SECRET_ACCESS_KEY||\"\",default_avatar:\"https://s3.amazonaws.com/37assets/svn/765-default-avatar.png\",stripe_key:process.env.STRIPE_KEY||\"\",service_fee:parseInt(process.env.SERVICE_FEE)||5,firebase_url:process.env.FIREBASE_DATA_URL||\"\"}},function(e,t){e.exports=require(\"sequelize\")},function(e,t){e.exports=require(\"passport\")},function(e,t){e.exports=require(\"express\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/classCallCheck\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/createClass\")},function(e,t){e.exports=require(\"winston\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/defineProperty\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/getPrototypeOf\")},function(e,t){e.exports=require(\"fs\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/inherits\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/possibleConstructorReturn\")},function(e,t){e.exports=require(\"moment\")},function(e,t){e.exports=require(\"winston-daily-rotate-file\")},function(e,t){e.exports=require(\"jsonwebtoken\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/get\")},function(e,t){e.exports=require(\"bcryptjs\")},function(e,t){e.exports=require(\"nodemailer\")},function(e,t){e.exports=require(\"firebase-admin\")},function(e,t){e.exports=require(\"body-parser\")},function(e,t){e.exports=require(\"uuid\")},function(e,t){e.exports=require(\"zlib\")},function(e,t){e.exports=require(\"passport-jwt\")},function(e,t){e.exports=require(\"http\")},function(e,t){e.exports=require(\"cors\")},function(e,t){e.exports=require(\"helmet\")},function(e,t){e.exports=require(\"dotenv\")},function(e,t){e.exports=require(\"express-formidable\")},function(e,t){e.exports=require(\"aws-sdk\")},function(e,t,r){\"use strict\";(function(e){var n=r(0),a=r.n(n),s=r(2),i=r.n(s),o=r(8),u=r.n(o),c=r(9),l=r.n(c),d=r(21),p=r.n(d),f=r(34),h=r.n(f),m=r(35),v=r.n(m),_=r(13),y=r.n(_),g=r(4),k=r(3),b=function(){function e(){u()(this,e),this.transporter=p.a.createTransport({service:\"gmail\",host:\"smtp.gmail.com\",port:465,secure:!0,auth:{user:g.a.mail_sender_email,pass:g.a.mail_sender_password}})}var t,r;return l()(e,[{key:\"sendConfirmationEmail\",value:(r=i()(a.a.mark((function e(t){var r,n,s,i,o,u,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.first_name,n=t.last_name,s=t.email,i=t.activation_code,o=t.activation_link,u=w({name:\"\".concat(r,\" \").concat(n),activation_link:o,activation_code:i,company_name:g.a.company_name},\"./templates/confirm-email.html\"),e.next=4,this.transporter.sendMail({from:'\"'.concat(g.a.mail_sender_name,'\" ').concat(g.a.mail_sender_email),to:s,subject:g.a.confirm_mail_subject,html:u});case 4:return c=e.sent,k.a.info(\"Message sent: \".concat(c.messageId)),k.a.info(\"Preview URL: \".concat(p.a.getTestMessageUrl(c))),e.abrupt(\"return\",c);case 8:case\"end\":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:\"sendResetPasswordMail\",value:(t=i()(a.a.mark((function e(t){var r,n,s,i,o,u,c;return a.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.first_name,n=t.last_name,s=t.email,i=t.activation_code,o=t.activation_link,u=w({name:\"\".concat(r,\" \").concat(n),activation_link:o,activation_code:i,company_name:g.a.company_name},\"./templates/reset-password-email.html\"),e.next=4,this.transporter.sendMail({from:'\"'.concat(g.a.mail_sender_name,'\" ').concat(g.a.mail_sender_email),to:s,subject:g.a.reset_password_mail_subject,html:u});case 4:return c=e.sent,k.a.info(\"Message sent: \".concat(c.messageId)),k.a.info(\"Preview URL: \".concat(p.a.getTestMessageUrl(c))),e.abrupt(\"return\",c);case 8:case\"end\":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),w=function(t,r){var n=function(e){try{return y.a.readFileSync(e,{encoding:\"utf-8\"})}catch(e){throw k.a.error(e),e}}(v.a.join(e,r));return h.a.compile(n)(t)},x=new b;t.a=x}).call(this,\"src/middleware/mailer\")},function(e,t){e.exports=require(\"handlebars\")},function(e,t){e.exports=require(\"path\")},function(e,t){e.exports=require(\"@babel/runtime/helpers/typeof\")},function(e,t){e.exports=require(\"qrcode\")},function(e,t){e.exports=require(\"stripe\")},function(e,t){e.exports=require(\"passport-local\")},function(e,t,r){e.exports=r(43)},function(e,t){e.exports=require(\"lodash\")},function(e){e.exports=JSON.parse('{\"type\":\"service_account\",\"project_id\":\"eventree-chat\",\"private_key_id\":\"f61fa0333f03c536d8d992358cef6ad551821b02\",\"private_key\":\"-----BEGIN PRIVATE KEY-----\\\\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC7DrbmaWo5iS8Q\\\\nspkA55FB0f7TBIRaVa2jQyjUqXOQg92ANNr1geZw7tTpDQzgrEmD+j/KGOXm+Y4p\\\\nmQRsHVB7cxztg/eGNIay7NbGJQwoMWfavUK5xGIK1Ao1guALgPiQLLklVB0SjUai\\\\nSqLPooU4rNZo6FB9w8opoi3EOPkI2lvba14l+chSwnvCZcNP6HP7EX95TYUhP38B\\\\nolbOzu52Y4tMOT+QyoNoO0H1bKacSOKMZmKdsQJFOZBcDHlFxNALSTHEh43bNq1u\\\\nfl2FDxU6IfUm4DYQq7O7WwoS/CIXKA/JGFKV/eB7xzmVC/wdBwbUwg5UmqgmdxHL\\\\n9vpG3/0NAgMBAAECggEAAS3Xi7gRROaJGgvSw7nKj1qX/MdA4D3kqtsvkumW6JqA\\\\nLoWQnWAMy/ncfkel3/9cyLpa/gB9IvTAKeadV+zir4r7MNU7ShdoA5EiCHBIEvhm\\\\nI1wLKFcbV8rItrCYv29alW8kRbJxqwHnJ91N13SiAhJPwIS5louBy9lFQYrcULAh\\\\n/BSlQS47McKFFFMOXdGv79Z2A1oY/nO+8xX6cnjwayUrXZNG/zbzqZZd9TaSs91G\\\\n26bMGcwfzippqMZhFLLcz2fH2HojqxgCDP2rNCPPzWDBDA2O/azDZJ1JHwM89DfG\\\\n63y15+Tpf7wHGnBu7UTINqj4hfv2Ds8KilR5Tz7xsQKBgQDinvQtdDVqBDNPiFfN\\\\nswT55utmkLewX+Z2TSvOyIi01k6KH0L/te0blsZOuNLKEI34XVzCGq2E9KInH61o\\\\nTKJ047rZnGVQ+/7H71XDtSl/LdBbJ7EjOcILwfoNtrNWikeJDVUHs7q1RIaObHTa\\\\nYLlTvUXtsbjz8e9j24TjvUuQvQKBgQDTTrzj+13P8iMoINkzk+rKYBQ319gUpmJ/\\\\ncq/0CiJx3xI4noG/LLXYFKc/748awhxPUwodOrzNfrI9FZd9X82InuCfSZ6N9QyY\\\\nEcA84PcOqrcW//0HU1dBUi9GX8GTbyeWpX3bHblx3giT/NGKAfyftsd8xklG2Yaw\\\\nP2b6VeQqkQKBgQCsX42JWWAbkLBaqXFn4+hAEVYygJdHz9ojV9Wfhsb9DhlVVCwJ\\\\nBp8gohGa5VhoHClwpcsdVV9wxwbjzWN/9vKHCIUiaqRh8hs8hp5sq0qyEu3tuAYz\\\\nrgYcHWKOtc45YBrDc2Ge5yV4JXRXtsU3KeUtfcVH5CuzWe3lvZ6Z/20P3QKBgAeS\\\\n4ehWASXL6wCsNLzJh3fbe74IqYEL+anRxYa8ukFUmoWXANWGV7o3+0qqXnm6DWO2\\\\neT1U9qFy8haIaJag0XAdKbXr4Jf7+YiV0kscUR6gddGIOVyC2zTHKlSeaATNziBz\\\\nLBCnfxcauzn6rNQCgDiFR58sSEIW1+IHU7yTSYtRAoGAIpVdJALNbBxwZaeXNxr8\\\\nYTtvH/RaWPRWmAChyT+EBOVPzodHp+jAMKJdk1j4xfexfFYwKCUTWiQWVcbfWEAy\\\\nN0L93bqi4605hxGozwJIy44rEIecxUze2pQtTX0uBkTG4WoQ+V21TYe15OcUQ/wJ\\\\nrNe1feReGqOQLs2F1+8VUTE=\\\\n-----END PRIVATE KEY-----\\\\n\",\"client_email\":\"firebase-adminsdk-py5cf@eventree-chat.iam.gserviceaccount.com\",\"client_id\":\"100838832527522586720\",\"auth_uri\":\"https://accounts.google.com/o/oauth2/auth\",\"token_uri\":\"https://oauth2.googleapis.com/token\",\"auth_provider_x509_cert_url\":\"https://www.googleapis.com/oauth2/v1/certs\",\"client_x509_cert_url\":\"https://www.googleapis.com/robot/v1/metadata/x509/firebase-adminsdk-py5cf%40eventree-chat.iam.gserviceaccount.com\"}')},function(e,t,r){\"use strict\";function n(e){var t=w.a.genSaltSync(10);return{hash:w.a.hashSync(e,t),salt:t}}r.r(t);var a=r(7),s=r.n(a),i=r(27),o=r.n(i),u=r(23),c=r.n(u),l=r(28),d=r.n(l),p=r(29),f=r.n(p),h=r(4),m=r(0),v=r.n(m),_=r(2),y=r.n(_),g=r(5),k=r.n(g),b=r(20),w=r.n(b),x=r(11),E=r.n(x),N=r(3),T=k.a.Op,O=new k.a(h.a.db_name,h.a.db_user,h.a.db_pass,{host:h.a.db_host,port:h.a.db_port,dialect:h.a.db_dialect,pool:{max:20,min:0,idle:1e4},logging:!1}),A={};A.Activation=function(e,t){return e.define(\"activation\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},code:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},hash:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},status:{type:t.INTEGER,allowNull:!1,defaultValue:0,validate:{isNumeric:!0},comment:\"0 - created, 1 - success, 2 - failed\"},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.User=function(e,t){var r=e.define(\"user\",{email:{type:t.STRING,unique:!0,validate:{isEmail:!0}},first_name:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},last_name:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},password:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0,len:[6,200]}},photo:{type:t.STRING,allowNull:!0},country_code:{type:t.STRING,allowNull:!0},phonenumber:{type:t.STRING,allowNull:!0},gender:{type:t.INTEGER,allowNull:!0,default:0,comment:\"0 - male, 1 - female\"},age_range:{type:t.INTEGER,allowNull:!0,default:0,comment:\"0 - 10~20, 1 - 20~30, 2 - 30~40 3 - above\"},address:{type:t.STRING,allowNull:!0},preferences:{type:t.TEXT,allowNull:!0},cash:{type:t.FLOAT,allowNull:!0,validate:{isNumeric:!0},defaultValue:0},salt:{type:t.STRING},status:{type:t.INTEGER,allowNull:!1,defaultValue:0,validate:{isNumeric:!0},comment:\"0 - created, 1 - active, 2 - blocked, 3 - delete\"},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}});return r.findByLogin=function(){var e=y()(v.a.mark((function e(t){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.findOne({where:{email:t}});case 2:return n=e.sent,e.abrupt(\"return\",n);case 4:case\"end\":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r.beforeCreate((function(e,t){var r=n(e.password),a=r.hash,s=r.salt;e.password=a,e.salt=s})),r.beforeBulkUpdate((function(e,t){var r,a,s;e.attributes&&e.attributes.password&&(a=(r=n(e.attributes.password)).hash,s=r.salt,e.attributes.password=a,e.attributes.salt=s)})),r.prototype.validatePassword=function(e){return w.a.compare(e,this.password)},r}(O,k.a),A.UserLogin=function(e,t){var r=e.define(\"user_login\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},login_type:{type:t.INTEGER,allowNull:!1,defaultValue:0,validate:{isNumeric:!0},comment:\"0 - web, 1 - mobile\"},refresh_token:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},lifetime:{type:t.BIGINT},login:t.DATE,refresh:t.DATE,logout:t.DATE,status:{type:t.INTEGER,allowNull:!1,defaultValue:0,validate:{isNumeric:!0},comment:\"0 - login, 1 - refresh, 2 - timeout, 3 - logout\"},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}});return r.beforeCreate(function(){var e=y()(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.expireOldLogins(t.user_id);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),N.a.error(\"Error on expiring old refresh tokens: \".concat(e.t0));case 8:t.login=(new Date).toLocaleString();case 9:case\"end\":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()),r.expireOldLogins=function(){var e=y()(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.update({logout:(new Date).toLocaleString(),status:3},{where:{user_id:t,status:E()({},T.lt,2)}});case 2:case\"end\":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),r}(O,k.a),A.Event=function(e,t){return e.define(\"event\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},title:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},description:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},content:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},online_event:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},location:{type:t.STRING,allowNull:!1,validate:{notEmpty:!1}},lat:{type:t.DOUBLE,allowNull:!1,default:0,validate:{notEmpty:!1}},lng:{type:t.DOUBLE,allowNull:!1,default:0,validate:{notEmpty:!1}},total_ticket:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},ticket_limit:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},poster:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},start_date:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},end_date:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},free_event:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},price:{type:t.FLOAT,allowNull:!1,validate:{notEmpty:!0}},restriction_age:{type:t.INTEGER,allowNull:!0},restriction_dress:{type:t.TEXT,allowNull:!0},restriction_refund:{type:t.TEXT,allowNull:!0},restriction_id:{type:t.INTEGER,allowNull:!1,defaultValue:0,comment:\"0 - not required, 1 - required\"},restriction_cash:{type:t.INTEGER,allowNull:!1,defaultValue:0,comment:\"0 - not accepted, 1 - accepted\"},qrcode:{type:t.TEXT,allowNull:!0},status:{type:t.INTEGER,allowNull:!1,defaultValue:0,validate:{isNumeric:!0},comment:\"0 - active, 1 - inactive\"},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Comment=function(e,t){return e.define(\"comment\",{relation_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},type:{type:t.INTEGER,default:0,allowNull:!1,validate:{isNumeric:!0}},user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},text:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Reaction=function(e,t){return e.define(\"reaction\",{type:{type:t.INTEGER,allowNull:!1,defaultValue:0,comment:\"0 - event, 1 - comment\",validate:{isNumeric:!0}},relation_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},value:{type:t.INTEGER,allowNull:!1,defaultValue:0,comment:\"0 - none, 1 - like, 2 - dislike\",validate:{isNumeric:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Ticket=function(e,t){return e.define(\"ticket\",{event_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},amount:{type:t.INTEGER,allowNull:!1,default:1,validate:{isNumeric:!0}},price:{type:t.FLOAT,allowNull:!1,default:0,validate:{notEmpty:!0}},status:{type:t.INTEGER,allowNull:!1,defaultValue:0,comment:\"0 - active, 1 - deleted\",validate:{isNumeric:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.PaymentHistory=function(e,t){return e.define(\"payment_history\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},related_user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},amount:{type:t.FLOAT,allowNull:!1,default:0,validate:{isNumeric:!0}},type:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0},default:0,comment:\"0 - in, 1 - out\"},description:{type:t.TEXT,allowNull:!0},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.TicketPurchase=function(e,t){return e.define(\"ticket_purchase\",{event_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},amount:{type:t.INTEGER,allowNull:!1,default:1,validate:{isNumeric:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Relation=function(e,t){return e.define(\"relation\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},follower_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Market=function(e,t){return e.define(\"market\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},ticket_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},amount:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},price:{type:t.FLOAT,allowNull:!1,validate:{notEmpty:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.NotificationToken=function(e,t){return e.define(\"notification_token\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},token:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Notification=function(e,t){return e.define(\"notification\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},title:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},content:{type:t.TEXT,allowNull:!1,validate:{notEmpty:!0}},read:{type:t.INTEGER,allowNull:!1,default:0,comment:\"0 - unread, 1 - read\",validate:{notEmpty:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.SocialUser=function(e,t){return e.define(\"socialuser\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},type:{type:t.INTEGER,allowNull:!1,comment:\"0 - google, 1-fb, 2-apple\",validate:{isNumeric:!0}},social_id:{type:t.TEXT,allowNull:!1},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Attend=function(e,t){return e.define(\"attend\",{event_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},user_id:{type:t.INTEGER,allowNull:!1,validate:{isNumeric:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.Community=function(e,t){return e.define(\"community\",{user_id:{type:t.INTEGER,allowNull:!1,validate:{notEmpty:!0}},title:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},content:{type:t.TEXT(\"long\"),allowNull:!1,validate:{notEmpty:!0}},poster:{type:t.STRING,allowNull:!1,validate:{notEmpty:!0}},createdAt:{field:\"create_date\",type:t.DATE,defaultValue:t.NOW},updatedAt:{field:\"update_date\",type:t.DATE,defaultValue:t.NOW}})}(O,k.a),A.User.hasMany(A.UserLogin,{foreignKey:\"user_id\"}),A.UserLogin.belongsTo(A.User,{foreignKey:\"user_id\"}),A.User.hasMany(A.Comment,{as:\"comments\",foreignKey:\"user_id\"}),A.Comment.belongsTo(A.User,{as:\"user\",foreignKey:\"user_id\"}),A.User.hasMany(A.Reaction,{as:\"reactions\",foreignKey:\"user_id\"}),A.Reaction.belongsTo(A.User,{as:\"user\",foreignKey:\"user_id\"}),A.User.hasMany(A.Ticket,{as:\"tickets\",foreignKey:\"user_id\"}),A.Ticket.belongsTo(A.User,{as:\"owner\",foreignKey:\"user_id\"}),A.User.hasMany(A.TicketPurchase,{as:\"purchase_histories\",foreignKey:\"user_id\"}),A.TicketPurchase.belongsTo(A.User,{as:\"buyer\",foreignKey:\"user_id\"}),A.User.hasMany(A.Market,{as:\"user_tickets\",foreignKey:\"user_id\"}),A.Market.belongsTo(A.User,{as:\"owner\",foreignKey:\"user_id\"}),A.User.hasOne(A.NotificationToken,{as:\"my_notification_token\",foreignKey:\"user_id\"}),A.NotificationToken.belongsTo(A.User,{as:\"user\",foreignKey:\"user_id\"}),A.User.hasMany(A.Notification,{as:\"my_notifications\",foreignKey:\"user_id\"}),A.Notification.belongsTo(A.User,{as:\"user\",foreignKey:\"user_id\"}),A.User.hasMany(A.PaymentHistory,{as:\"payment_historys\",foreignKey:\"user_id\"}),A.PaymentHistory.belongsTo(A.User,{as:\"user\",foreignKey:\"user_id\"}),A.User.hasMany(A.PaymentHistory,{as:\"payment_related_historys\",foreignKey:\"related_user_id\"}),A.PaymentHistory.belongsTo(A.User,{as:\"related_user\",foreignKey:\"related_user_id\"}),A.User.hasMany(A.Event,{as:\"events\",foreignKey:\"user_id\"}),A.Event.belongsTo(A.User,{as:\"creator\",foreignKey:\"user_id\"}),A.Event.hasMany(A.Comment,{as:\"comments\",foreignKey:\"relation_id\"}),A.Comment.belongsTo(A.Event,{foreignKey:\"relation_id\"}),A.Event.hasMany(A.Reaction,{as:\"likes\",foreignKey:\"relation_id\",constraints:!1}),A.Event.hasMany(A.Reaction,{as:\"dislikes\",foreignKey:\"relation_id\",constraints:!1}),A.Reaction.belongsTo(A.Event,{foreignKey:\"relation_id\",constraints:!1}),A.Event.hasMany(A.Ticket,{as:\"tickets\",foreignKey:\"event_id\"}),A.Ticket.belongsTo(A.Event,{as:\"eventinfo\",foreignKey:\"event_id\"}),A.Event.hasMany(A.TicketPurchase,{as:\"purchase_histories\",foreignKey:\"event_id\"}),A.TicketPurchase.belongsTo(A.Event,{as:\"eventinfo\",foreignKey:\"event_id\"}),A.User.hasMany(A.Relation,{as:\"followers\",foreignKey:\"user_id\"}),A.Relation.belongsTo(A.User,{as:\"user_info\",foreignKey:\"user_id\"}),A.User.hasMany(A.Relation,{as:\"following\",foreignKey:\"follower_id\"}),A.Relation.belongsTo(A.User,{as:\"follower\",foreignKey:\"follower_id\"}),A.Ticket.hasMany(A.Market,{as:\"on_market\",foreignKey:\"ticket_id\"}),A.Market.belongsTo(A.Ticket,{as:\"ticket_info\",foreignKey:\"ticket_id\"}),A.Event.hasMany(A.Attend,{as:\"attenders\",foreignKey:\"event_id\"}),A.Attend.belongsTo(A.Event,{as:\"event_info\",foreignKey:\"event_id\"}),A.Community.hasMany(A.Comment,{as:\"comments\",foreignKey:\"relation_id\"}),A.Comment.belongsTo(A.Community,{foreignKey:\"relation_id\"}),A.transaction=function(){var e=y()(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,O.transaction(t);case 2:return e.abrupt(\"return\",e.sent);case 3:case\"end\":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Object.keys(A).forEach((function(e){\"associate\"in A[e]&&A[e].associate(A)}));var R=A,I=r(1),S=r.n(I),q=r(31),D=r.n(q),j=r(8),U=r.n(j),P=r(9),C=r.n(P),M=r(32),L=r.n(M),G=r(13),W=r.n(G),K=r(24),V=new L.a.S3({accessKeyId:h.a.aws_access_key_id,secretAccessKey:h.a.aws_secret_access_key}),B=new(function(){function e(){U()(this,e)}return C()(e,[{key:\"uploadFile\",value:function(e){try{var t=W.a.readFileSync(e.path),r=\"png\";-1<e.name.lastIndexOf(\".\")&&(r=e.name.split(\".\")[1]);var n={Bucket:\"eventree-bucket\",Key:\"\".concat(Object(K.v4)(),\".\").concat(r),Body:t};return V.upload(n).promise().then((function(e){return N.a.info(\"File uploaded successfully. \".concat(e.Location)),e})).catch((function(e){throw e}))}catch(e){throw N.a.error(\"Error uploading to s3 :\",e),e}}},{key:\"upload64\",value:function(e){try{var t=e.uri,r=(e.name,new Buffer.from(t.replace(/^data:image\\/\\w+;base64,/,\"\"),\"base64\")),n=t.split(\";\")[0].split(\"/\")[1],a={Bucket:\"eventree-bucket\",Key:\"\".concat(Object(K.v4)(),\".\").concat(n),Body:r,ACL:\"public-read\",ContentEncoding:\"base64\",ContentType:\"image/\".concat(n)};return V.upload(a).promise().then((function(e){return N.a.info(\"File uploaded successfully. \".concat(e.Location)),e})).catch((function(e){throw e}))}catch(e){throw N.a.error(\"Error uploading to s3 :\",e),e}}}]),e}()),Y=Object(a.Router)();Y.post(\"/upload\",D()(),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.files.file,a=S.a.object().keys({file:S.a.any().meta({swaggerType:\"file\"}).required()}),e.prev=2,S.a.assert({file:n},a,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),s=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:s}));case 10:return e.prev=10,e.next=13,B.uploadFile(n);case 13:i=e.sent,r.status(200).send({data:{url:i.Location}}),e.next=21;break;case 17:e.prev=17,e.t1=e.catch(10),N.a.error(\"Error on uploading file:\",e.t1),r.status(500).send({errors:[e.t1]});case 21:case\"end\":return e.stop()}}),e,null,[[2,6],[10,17]])})));return function(t,r){return e.apply(this,arguments)}}()),Y.post(\"/upload_base64\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.uri,s=n.name,i=S.a.object().keys({uri:S.a.string().required(),name:S.a.string().required()}),e.prev=2,S.a.assert({uri:a,name:s},i,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),o=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:o}));case 10:return e.prev=10,e.next=13,B.upload64({uri:a,name:s});case 13:u=e.sent,r.status(200).send({data:{url:u.Location}}),e.next=21;break;case 17:e.prev=17,e.t1=e.catch(10),N.a.error(\"Error on uploading file:\",e.t1),r.status(500).send({errors:[e.t1]});case 21:case\"end\":return e.stop()}}),e,null,[[2,6],[10,17]])})));return function(t,r){return e.apply(this,arguments)}}());var F=Y,H=r(6),J=r.n(H),X=r(18),z=r.n(X),Q=r(33).a,Z=r(16),$=r.n(Z),ee=(r(41),r(25)),te=r.n(ee),re=r(19),ne=r.n(re),ae=r(14),se=r.n(ae),ie=r(15),oe=r.n(ie),ue=r(12),ce=r.n(ue),le=function(){function e(t,r,n){U()(this,e),this.entity=t+\"\",this.__uniqid__=n,this.load(r||{})}return C()(e,[{key:\"load\",value:function(e){var t=Object.create(null);return Object.keys(e).forEach((function(r){t[r]=e[r]})),this.properties=t,this}},{key:\"set\",value:function(e,t){return this.properties[e]=t}},{key:\"unset\",value:function(e){return delete this.properties[e]}},{key:\"has\",value:function(e){return Object.prototype.hasOwnProperty.call(this.properties,e)}},{key:\"get\",value:function(e){return this.properties[e]}},{key:\"toString\",value:function(){return[this.constructor.name,\" (\",this.entity,\" \",JSON.stringify(this.properties),\")\"].join(\"\")}},{key:\"valueOf\",value:function(){return this.toString()}},{key:\"toJSON\",value:function(){return[this.entity,this.properties,this.__uniqid__]}}]),e}();var de=function(e){se()(r,e);var t=function(e){var t=function(){if(\"undefined\"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(\"function\"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n,a=ce()(e);return n=t?(r=ce()(this).constructor,Reflect.construct(a,arguments,r)):a.apply(this,arguments),oe()(this,n)}}(r);function r(e,n,a){var s;return U()(this,r),(s=t.call(this,e,n,a)).edges=[],s.inputEdges=[],s.outputEdges=[],s}return C()(r,[{key:\"unlink\",value:function(){for(var e=this.edges,t=0,r=e.length;t<r;t++)e[t].unlink();return!0}},{key:\"toJSON\",value:function(){return ne()(ce()(r.prototype),\"toJSON\",this).call(this)}}]),r}(le);var pe=function(e){se()(r,e);var t=function(e){var t=function(){if(\"undefined\"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(\"function\"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n,a=ce()(e);return n=t?(r=ce()(this).constructor,Reflect.construct(a,arguments,r)):a.apply(this,arguments),oe()(this,n)}}(r);function r(e,n,a){var s;return U()(this,r),(s=t.call(this,e,n,a)).inputNode=null,s.outputNode=null,s.duplex=!1,s.distance=1,s}return C()(r,[{key:\"_linkTo\",value:function(e,t){return t<=0&&e.inputEdges.push(this),0<=t&&e.outputEdges.push(this),e.edges.push(this),!0}},{key:\"link\",value:function(e,t,r){return this.unlink(),this.inputNode=e,this.outputNode=t,this.duplex=!!r,r?(this._linkTo(e,0),this._linkTo(t,0)):(this._linkTo(e,1),this._linkTo(t,-1)),this}},{key:\"setDistance\",value:function(e){return this.distance=Math.abs(parseFloat(e)||0),this}},{key:\"setWeight\",value:function(e){return this.distance=1/Math.abs(parseFloat(e)||0),this}},{key:\"oppositeNode\",value:function(e){return this.inputNode===e?this.outputNode:this.outputNode===e?this.inputNode:void 0}},{key:\"unlink\",value:function(){var e,t=this.inputNode,r=this.outputNode;if(t&&r)return-1<(e=t.edges.indexOf(this))&&t.edges.splice(e,1),-1<(e=r.edges.indexOf(this))&&r.edges.splice(e,1),-1<(e=t.outputEdges.indexOf(this))&&t.outputEdges.splice(e,1),-1<(e=r.inputEdges.indexOf(this))&&r.inputEdges.splice(e,1),this.duplex&&(-1<(e=t.inputEdges.indexOf(this))&&t.inputEdges.splice(e,1),-1<(e=r.outputEdges.indexOf(this))&&r.outputEdges.splice(e,1)),this.inputNode=null,this.outputNode=null,!(this.duplex=!1)}},{key:\"toJSON\",value:function(){return ne()(ce()(r.prototype),\"toJSON\",this).call(this).concat([this.inputNode.__uniqid__,this.outputNode.__uniqid__,0|this.duplex,this.distance])}}]),r}(le),fe=r(36),he=r.n(fe),me={is:function(e,t){return e===t},not:function(e,t){return e!==t},gt:function(e,t){return t<e},lt:function(e,t){return e<t},gte:function(e,t){return t<=e},lte:function(e,t){return e<=t},ilike:function(e,t){return-1<e.toLowerCase().indexOf(t.toLowerCase())},like:function(e,t){return-1<e.indexOf(t)},in:function(e,t){return-1<t.indexOf(e)},not_in:function(e,t){return-1===t.indexOf(e)}},ve=function(){function e(t){U()(this,e),this._units=t.slice()}return C()(e,[{key:\"__filter\",value:function(t,r){r=!!r;for(var n=0,a=t.length;n<a;n++)\"object\"===he()(t[n])&&null!==t[n]||(t[n]={});t.length||(t=[{}]);for(var s,i,o,u,c,l,d,p,f,h=this._units.slice(),m=t.length,v=0;v!==m;v++){s=t[v],u=[];for(var _=0,y=(i=Object.keys(s)).length;_<y;_++){if((c=(o=i[_]).split(\"__\")).length<2&&c.push(\"is\"),l=c.pop(),!me[l])throw new Error('Filter type \"'+l+'\" not supported.');u.push([me[l],c,s[o]])}t[v]=u}var g,k=h.length,b=0,w=Array(k);try{for(var x=0;x!==k;x++)for(var E=h[x],N=E.properties,T=!0,O=0;O!==m&&T;O++){T=!1,f=(u=t[O]).length;for(var A=0;A!==f&&!T;A++){p=(d=u[A])[0],g=N,o=d[1];for(var R=0,I=o.length;R!==I;R++)g=g[o[R]];p(g,d[2])===r&&(T=!0)}T||(w[b++]=E)}}catch(t){throw console.log(t),new Error(\"Nested field \"+o.join(\"__\")+\" does not exist\")}return new e(w=w.slice(0,b))}},{key:\"filter\",value:function(){var e=(e=[].slice.call(arguments))[0]instanceof Array?e[0]:e;return this.__filter(e,!1)}},{key:\"exclude\",value:function(){var e=(e=[].slice.call(arguments))[0]instanceof Array?e[0]:e;return this.__filter(e,!0)}},{key:\"first\",value:function(){return this._units[0]}},{key:\"last\",value:function(){var e=this._units;return e[e.length-1]}},{key:\"units\",value:function(){return this._units.slice()}}]),e}(),_e=function(){function e(t){U()(this,e),this._name=t,this._units=[],this._indices=Object.create(null),this._indicesList=[]}return C()(e,[{key:\"name\",value:function(){return this._name}},{key:\"indices\",value:function(){return this._indicesList.slice()}},{key:\"toJSON\",value:function(){return[this._name,this._indicesList.slice()]}},{key:\"createIndex\",value:function(e){return this.createIndices([e])}},{key:\"createIndices\",value:function(e){this._indicesList=this._indicesList.concat(e);for(var t=this._indices,r=this._units,n=0,a=e.length;n<a;n++)for(var s=e[n],i=t[s]=Object.create(null),o=0,u=r.length;o<u;o++){var c=r[o],l=c.get(s);l&&(i[l]=c)}return this}},{key:\"_add\",value:function(e){if(e){this._units.push(e);for(var t=this._indicesList,r=t.length,n=this._indices,a=0;a<r;a++){var s=t[a],i=n[s],o=e.get(s);o&&(i[o]=e)}}return e}},{key:\"_remove\",value:function(e){if(e){var t=this._units.indexOf(e);-1<t&&this._units.splice(t,1);for(var r=this._indicesList,n=r.length,a=this._indices,s=0;s<n;s++){var i=r[s];delete a[i][e.get(i)]}}return e}},{key:\"find\",value:function(e,t){t||(t=e,e=this._indicesList[0]);var r=this._indices[e];return r&&r[t]}},{key:\"destroy\",value:function(e,t){t||(t=e,e=this._indicesList[0]);var r=this._indices[e];return r&&this._remove(r[t])}},{key:\"query\",value:function(){return new ve(this._units)}}]),e}();var ye=function(e){se()(r,e);var t=function(e){var t=function(){if(\"undefined\"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(\"function\"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n,a=ce()(e);return n=t?(r=ce()(this).constructor,Reflect.construct(a,arguments,r)):a.apply(this,arguments),oe()(this,n)}}(r);function r(){return U()(this,r),t.apply(this,arguments)}return r}(_e);function ge(e){var t=e<=1?1:Math.pow(10,e-1);return Math.floor(t+9*Math.random()*t)}var ke=function(e){se()(r,e);var t=function(e){var t=function(){if(\"undefined\"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if(\"function\"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n,a=ce()(e);return n=t?(r=ce()(this).constructor,Reflect.construct(a,arguments,r)):a.apply(this,arguments),oe()(this,n)}}(r);function r(){return U()(this,r),t.apply(this,arguments)}return r}(_e),be=function(){function e(t){U()(this,e),this._raw=t.slice()}return C()(e,[{key:\"start\",value:function(){return this._raw[0]}},{key:\"end\",value:function(){return this._raw[this._raw.length-1]}},{key:\"length\",value:function(){return this._raw.length>>>1}},{key:\"distance\",value:function(){return this._raw.filter((function(e,t){return!!(1&t)})).reduce((function(e,t){return e+t.distance}),0)}},{key:\"prettify\",value:function(){return this._raw.map((function(e,t,r){var n=e.toString();if(1&t){if(e.duplex)return[\"<>\",n,\"<>\"].join(\" \");var a=r[t-1];return e.inputNode===a?[\">>\",n,\">>\"].join(\" \"):[\"<<\",n,\"<<\"].join(\" \")}return n})).join(\" \")}},{key:\"toString\",value:function(){return this.prettify()}}]),e}(),we=function(){function e(){U()(this,e),this.__uniqval__=Number.MAX_SAFE_INTEGER,this.__init__()}return C()(e,[{key:\"__init__\",value:function(){this._lookup=Object.create(null),this._nodes=[],this._edges=[],this._nodeCollections=Object.create(null),this._edgeCollections=Object.create(null)}},{key:\"unit\",value:function(e){return this._lookup[e]}},{key:\"nodeCount\",value:function(){return this._nodes.length}},{key:\"edgeCount\",value:function(){return this._edges.length}},{key:\"createNode\",value:function(e,t){return this._createNode(e,t,(this.__uniqval__--).toString(16))}},{key:\"_createNode\",value:function(e,t,r){return this._addNode(new de(e,t,r))}},{key:\"_addNode\",value:function(e){return this._nodes.push(e),this._lookup[e.__uniqid__]=e,this.nodes(e.entity)._add(e)}},{key:\"createEdge\",value:function(e,t){return this._createEdge(e,t,(this.__uniqval__--).toString(16))}},{key:\"_createEdge\",value:function(e,t,r){return this._addEdge(new pe(e,t,r))}},{key:\"_addEdge\",value:function(e){return this._edges.push(e),this._lookup[e.__uniqid__]=e,this.edges(e.entity)._add(e)}},{key:\"nodes\",value:function(e){return this._nodeCollections[e]||(this._nodeCollections[e]=new ye(e))}},{key:\"edges\",value:function(e){return this._edgeCollections[e]||(this._edgeCollections[e]=new ke(e))}},{key:\"_getPath\",value:function(e,t){for(var r=t[e.__uniqid__];r[0]instanceof pe;)r=t[r[0].oppositeNode(r[1]).__uniqid__].concat(r);return r}},{key:\"closest\",value:function(e,t){return t=t||{},this._search(e,t.compare,t.count,t.direction,t.minDepth,t.maxDepth)}},{key:\"trace\",value:function(e,t,r){return this._search(e,(function(e){return e===t}),1,r)[0]||new be([])}},{key:\"_search\",value:function(e,t,r,n,a,s){t=\"function\"==typeof t?t:function(e){return!0},n|=0,r=Math.max(0,0|r),a=Math.max(0,0|a),s=Math.max(0,0|s);var i=Object.create(null);i[e.__uniqid__]=[e];var o=new Map;o.set(0,[e]);var u=[0],c=[],l=this._getPath;function d(e,t){o.has(t)?o.get(t).push(e):o.set(t,[e]),function(e,t){for(var r=e.length,n=r>>>1;r;){if(r>>>=1,e[n]===t)return;e[n]<t?n+=r:n-=r}e.splice(n+(e[n]<t),0,t)}(u,t)}for(;u.length;)for(var p=u.shift(),f=o.get(p);f.length;){var h=function(e,r){for(var o=0===n?e.edges:0<n?e.outputEdges:e.inputEdges,u=o.length-1;-1<u;u--){var c,p=o[u],f=r+p.distance;s&&s<f||(c=o[u].oppositeNode(e),i[c.__uniqid__]||(i[c.__uniqid__]=[p,c],d(c,f)))}return!!(a<=r&&t(e))&&new be(l(e,i))}(f.shift(),p);if(h&&c.push(h),r&&c.length>=r)return c}return c}},{key:\"toJSON\",value:function(){var e=this._nodeCollections,t=Object.keys(e).map((function(t){return e[t].toJSON()})),r=this._edgeCollections,n=Object.keys(r).map((function(e){return r[e].toJSON()})),a=this._nodes.map((function(e){return e.toJSON()})),s=this._edges.map((function(e){return e.toJSON()}));return JSON.stringify({nc:t,ec:n,n:a,e:s})}},{key:\"fromJSON\",value:function(e){this.__init__();for(var t=JSON.parse(e),r=t.nc,n=t.ec,a=0,s=r.length;a<s;a++){var i=r[a];this.nodes(i[0]).createIndices(i[1])}for(var o=0,u=n.length;o<u;o++){var c=n[o];this.edges(c[0]).createIndices(c[1])}for(var l=t.n,d=t.e,p=0,f=l.length;p<f;p++){var h=l[p];this._createNode(h[0],h[1],h[2]);var m=parseInt(h[2],16);this.__uniqval__=m<this.__uniqval__?m-1:this.__uniqval__}for(var v=0,_=d.length;v<_;v++){var y=d[v];this._createEdge(y[0],y[1],y[2]).link(this._lookup[y[3]],this._lookup[y[4]],y[5]).setDistance(y[6]);var g=parseInt(y[2],16);this.__uniqval__=g<this.__uniqval__?g-1:this.__uniqval__}return this}},{key:\"gzip\",value:function(e){var t=new Buffer(this.toJSON());return e=e.bind(this),te.a.gzip(t,e),this}},{key:\"gunzip\",value:function(e,t){t=t.bind(this);var r=this.fromJSON.bind(this);Buffer.isBuffer(e)||(e=new Buffer(e,\"binary\")),te.a.gunzip(e,(function(e,n){e||r(n.toString()),t(e)}))}},{key:\"save\",value:function(e,t){return t=t.bind(this),this.gzip((function(r,n){r?t(r):W.a.writeFile(e,n,t)})),this}},{key:\"load\",value:function(e,t){t=t.bind(this);var r=this.gunzip.bind(this);return W.a.readFile(e,(function(e,n){e?t(e):r(n,t)})),this}}]),e}(),xe=(k.a.Op,100),Ee=new(function(){function e(){U()(this,e),this.g=new we,this.rootNode=this.g.createNode(\"root\",{name:\"Root Node\"}),this.users={},this.events={},this.posts={},this.relations={},this.likes={},this.comments={}}var t;return C()(e,[{key:\"init\",value:(t=y()(v.a.mark((function e(){var t,r,n,a,s,i=this;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,R.User.findAll({where:{status:1},raw:!0});case 2:return t=e.sent,e.next=5,R.Event.findAll({where:{status:0},raw:!0});case 5:return r=e.sent,e.next=8,R.Relation.findAll({raw:!0});case 8:return n=e.sent,e.next=11,R.Reaction.findAll({raw:!0});case 11:return a=e.sent,e.next=14,R.Comment.findAll({raw:!0});case 14:s=e.sent,t.forEach((function(e){i.users[e.id]=i.g.createNode(\"user\",e),i.g.createEdge(\"root\").link(i.rootNode,i.users[e.id]).setDistance(xe)})),n.forEach((function(e){i.relations[e.id]=i.g.createEdge(\"relation\",e).link(i.users[e.user_id],i.users[e.follower_id]).setDistance(1)})),r.forEach((function(e){i.events[e.id]=i.g.createNode(\"event\",e),i.g.createEdge(\"root\").link(i.rootNode,i.events[e.id]).setDistance(xe),i.posts[e.id]=i.g.createEdge(\"post\").link(i.users[e.user_id],i.events[e.id]).setDistance(2)})),s.forEach((function(e){i.comments[e.id]=i.g.createEdge(\"comment\",e).link(i.users[e.user_id],i.events[e.relation_id]).setDistance(4)})),a.forEach((function(e){var t;1==e.value&&(0==e.type?i.likes[e.id]=i.g.createEdge(\"like\",e).link(i.users[e.user_id],i.events[e.relation_id]).setDistance(4):1!=e.type||(t=i.comments[e.relation_id])&&i.events[t.relation_id]&&(i.likes[e.id]=i.g.createEdge(\"like\",e).link(i.users[e.user_id],i.events[t.relation_id]).setDistance(6)))}));case 20:case\"end\":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:\"findEvents\",value:function(e,t,r,n){var a=3<arguments.length&&void 0!==n?n:20,s=this.users[e]||this.rootNode;return t=t&&t.toLowerCase(),this.g.closest(s,{compare:function(e){return\"event\"===e.entity&&(!t||-1<e.get(\"title\").toLowerCase().indexOf(t)||-1<e.get(\"description\").toLowerCase().indexOf(t))&&(!r||$()(e.get(\"createdAt\"))<$()(r))},minDepth:2,count:a}).map((function(e){return e.end()}))}},{key:\"addUser\",value:function(e){e&&!this.users[e.id]?(this.users[e.id]=this.g.createNode(\"user\",e),this.g.createEdge(\"root\").link(this.rootNode,this.users[e.id]).setDistance(xe),console.log(\"graph add user\",this.users[e.id])):N.a.error(\"null value of user\")}},{key:\"followUser\",value:function(e){e?(this.relations[e.id]||(this.relations[e.id]=this.g.createEdge(\"relation\",e)),this.relations[e.id].unlink(),this.relations[e.id].link(this.users[e.user_id],this.users[e.follower_id]).setDistance(1),console.log(\"graph follow user\",this.relations[e.id])):N.a.error(\"graph follow User error: null value of relation\")}},{key:\"unfollowUser\",value:function(e){e?this.relations[e.id]?(this.relations[e.id].unlink(),delete this.relations[e.id],console.log(\"graph unfollow user\",this.relations[e.id])):N.a.error(\"graph unfollow User error: not existing relation - \"+e):N.a.error(\"graph unfollow User error: null value of relation\")}},{key:\"addEvent\",value:function(e){e&&!this.events[e.id]?(this.events[e.id]=this.g.createNode(\"event\",e),this.posts[e.id]=this.g.createEdge(\"post\").link(this.users[e.user_id],this.events[e.id]).setDistance(2),console.log(\"graph add event\",this.events[e.id])):N.a.error(\"null value of event\")}},{key:\"addLike\",value:function(e){var t;e&&!this.likes[e.id]?1==e.value&&(0==e.type?this.likes[e.id]=this.g.createEdge(\"like\",e).link(this.users[e.user_id],this.events[e.relation_id]).setDistance(4):1!=e.type||(t=this.comments[e.relation_id])&&this.events[t.relation_id]&&(this.likes[e.id]=this.g.createEdge(\"like\",e).link(this.users[e.user_id],this.events[t.relation_id]).setDistance(6)),console.log(\"graph add like\",this.likes[e.id])):N.a.error(\"null value of reaction\")}},{key:\"updateLike\",value:function(e){if(e)if(1==e.value){if(this.likes[e.id])return void N.a.error(\"graph update like error: duplicated reaction \"+e);var t;0==e.type?this.likes[e.id]=this.g.createEdge(\"like\",e).link(this.users[e.user_id],this.events[e.relation_id]).setDistance(4):1!=e.type||(t=this.comments[e.relation_id])&&this.events[t.relation_id]&&(this.likes[e.id]=this.g.createEdge(\"like\",e).link(this.users[e.user_id],this.events[t.relation_id]).setDistance(6)),console.log(\"graph update like - like:\",this.likes[e.id])}else this.likes[e.id]&&(this.likes[e.id].unlink(),delete this.likes[e.id]),console.log(\"graph update like - unlike:\",e);else N.a.error(\"graph update like error: null value of reaction\")}},{key:\"addComment\",value:function(e){e&&!this.comments[e.id]?(this.comments[e.id]=this.g.createEdge(\"comment\",e).link(this.users[e.user_id],this.events[e.relation_id]).setDistance(4),console.log(\"graph add comment\",e)):N.a.error(\"null value of comment\")}},{key:\"deleteComment\",value:function(e){e&&this.comments[e.id]?(this.comments[e.id].unlink(),delete this.comments[e.id],console.log(\"graph delete comment\",e)):N.a.error(\"null value of comment\")}}]),e}()),Ne=Object(a.Router)(),Te=function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.id,a=t.first_name,s=t.last_name,i=t.email,o=t.status,u=t.photo,c=t.country_code,l=t.phonenumber,d=t.gender,p=t.age_range,f=t.address,m=t.preferences,_=t.cash,e.next=3,z.a.sign({id:n,first_name:a,last_name:s,email:i,status:o,photo:u,country_code:c,phonenumber:l,gender:d,age_range:p,address:f,preferences:m,cash:_},h.a.secret_key,{});case 3:return e.abrupt(\"return\",e.sent);case 4:case\"end\":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),Oe=function(){var e=y()(v.a.mark((function e(t){var r,n,a,s,i;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.id,n=t.first_name,a=t.last_name,s=t.email,(i={}).user_id=r,i.code=ge(h.a.activation_code_digit),e.next=6,z.a.sign({activation_code:i.code,email:s,time:(new Date).getTime()},h.a.secret_key,{expiresIn:h.a.activation_code_expiresin});case 6:return i.hash=e.sent,i.link=\"\".concat(h.a.web_root_url).concat(h.a.activation_link_url,\"?hval=\").concat(i.hash),e.prev=8,e.next=11,R.Activation.create(i);case 11:return e.next=13,Q.sendConfirmationEmail({first_name:n,last_name:a,email:s,activation_code:i.code,activation_link:i.link});case 13:e.next=19;break;case 15:throw e.prev=15,e.t0=e.catch(8),N.a.error(\"Error on sending activation code:\",e.t0),e.t0;case 19:case\"end\":return e.stop()}}),e,null,[[8,15]])})));return function(t){return e.apply(this,arguments)}}(),Ae=function(){var e=y()(v.a.mark((function e(t){var r,n,a,s,i;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.id,n=t.first_name,a=t.last_name,s=t.email,(i={}).user_id=r,i.code=ge(h.a.activation_code_digit),e.next=6,z.a.sign({activation_code:i.code,email:s,time:(new Date).getTime()},h.a.secret_key,{expiresIn:h.a.activation_code_expiresin});case 6:return i.hash=e.sent,i.link=\"\".concat(h.a.web_root_url).concat(h.a.reset_password_link_url,\"?hval=\").concat(i.hash),e.prev=8,e.next=11,R.Activation.create(i);case 11:return e.next=13,Q.sendResetPasswordMail({first_name:n,last_name:a,email:s,activation_code:i.code,activation_link:i.link});case 13:e.next=19;break;case 15:throw e.prev=15,e.t0=e.catch(8),N.a.error(\"Error on sending activation code:\",e.t0),e.t0;case 19:case\"end\":return e.stop()}}),e,null,[[8,15]])})));return function(t){return e.apply(this,arguments)}}(),Re=function(){var e=y()(v.a.mark((function e(t){var r,n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=new Date(t.createdAt),n=(new Date).getTime()-r.getTime(),0===t.status&&n/1e3<h.a.activation_code_expiresin)return e.abrupt(\"return\",!0);e.next=5;break;case 5:return e.next=7,R.Activation.update({status:2},{where:{id:t.id}});case 7:return e.abrupt(\"return\",!1);case 8:case\"end\":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Ie=function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,R.transaction();case 3:return n=e.sent,e.next=6,R.User.update({status:1},{where:{id:t.id},transaction:n});case 6:return e.next=8,R.Activation.update({status:1},{where:{id:r.id},transaction:n});case 8:return e.next=10,n.commit();case 10:e.next=19;break;case 12:if(e.prev=12,e.t0=e.catch(0),N.a.error(\"Error on active user:\",e.t0),n)return e.next=18,n.rollback();e.next=18;break;case 18:throw e.t0;case 19:case\"end\":return e.stop()}}),e,null,[[0,12]])})));return function(t,r){return e.apply(this,arguments)}}();Ne.post(\"/login\",J.a.authenticate(\"local\",{failWithError:!0}),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g,k,b,w,x,E,T,O,A,I,S,q,D,j,U,P,C;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,2<=t.user.status)return e.abrupt(\"return\",r.status(401).send({errors:[{message:\"This account is blocked, please contact to support.\"}]}));e.next=5;break;case 5:if(t.user.status<1)return n=t.user,a=n.id,s=n.first_name,i=n.last_name,o=n.email,u=n.photo,c=n.status,l=n.country_code,d=n.phonenumber,p=n.gender,f=n.age_range,m=n.address,_=n.preferences,y=n.cash,e.abrupt(\"return\",r.status(401).send({data:{user:{id:a,first_name:s,last_name:i,email:o,photo:u,status:c,country_code:l,phonenumber:d,gender:p,age_range:f,address:m,preferences:_,cash:y}},errors:[{message:\"This account isn't active. Please check our confirm email in your mailbox or resend.\"}]}));e.next=8;break;case 8:return g=t.body.login_type,k=t.user,b=k.id,w=k.first_name,x=k.last_name,E=k.email,T=k.photo,O=k.status,A=k.country_code,I=k.phonenumber,S=k.gender,q=k.age_range,D=k.address,j=k.preferences,U=k.cash,e.next=12,Te(t.user,h.a.token_expiresin);case 12:return P=e.sent,e.next=15,Te(t.user,h.a.refresh_token_expiresin);case 15:return C=e.sent,e.next=18,R.UserLogin.create({user_id:b,refresh_token:C,login_type:g});case 18:r.status(200).send({data:{user:{id:b,first_name:w,last_name:x,email:E,photo:T,status:O,country_code:A,phonenumber:I,gender:S,age_range:q,address:D,preferences:j,cash:U},token:P,refresh_token:C}}),e.next=25;break;case 21:e.prev=21,e.t0=e.catch(0),N.a.error(\"Error on login:\",e.t0),r.status(500).send({errors:[e.t0]});case 25:case\"end\":return e.stop()}}),e,null,[[0,21]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/signup\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g,k,b,w,x,E,T,O;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.email,s=n.first_name,i=n.last_name,o=n.password,u=n.login_type,c=S.a.object().keys({first_name:S.a.string().required(),last_name:S.a.string().required(),password:S.a.string().min(3).max(30).required(),email:S.a.string().email({minDomainSegments:2}).min(3).max(30).required(),login_type:S.a.number().required()}),e.prev=2,S.a.assert({email:a,first_name:s,last_name:i,password:o,login_type:u},c,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),l=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:l}));case 10:return e.prev=10,e.next=13,R.User.findOne({where:{email:a}});case 13:if(e.sent)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Email already exists\"}]}));e.next=16;break;case 16:return e.next=18,R.User.create({first_name:s,last_name:i,password:o,email:a,status:0,photo:h.a.default_avatar});case 18:return d=e.sent,p=d.get({plain:!0}),e.next=22,Te(p,h.a.token_expiresin);case 22:return f=e.sent,e.next=25,Te(p,h.a.refresh_token_expiresin);case 25:return m=e.sent,_=p.id,y=p.photo,g=p.status,k=p.country_code,b=p.phonenumber,w=p.gender,x=p.age_range,E=p.address,T=p.preferences,O=p.cash,e.next=29,R.UserLogin.create({user_id:_,refresh_token:m,login_type:u});case 29:Oe(p),r.status(200).send({data:{user:{id:_,email:a,first_name:s,last_name:i,photo:y,status:g,country_code:k,phonenumber:b,gender:w,age_range:x,address:E,preferences:T,cash:O},token:f,refresh_token:m}}),e.next=37;break;case 33:e.prev=33,e.t1=e.catch(10),N.a.error(\"Error on signup:\",e.t1),r.status(500).send({errors:[e.t1]});case 37:case\"end\":return e.stop()}}),e,null,[[2,6],[10,33]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/request_activation\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body.email,a=S.a.object().keys({email:S.a.string().email({minDomainSegments:2}).min(3).max(30).required()}),e.prev=2,S.a.assert({email:n},a,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),s=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:s}));case 10:return e.prev=10,e.next=13,R.User.findOne({where:{email:n}});case 13:if(i=e.sent){e.next=16;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your email isn't registered\"}]}));case 16:if(0!=i.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your account is already activated. Please try to login.\"}]}));e.next=18;break;case 18:Oe(i),r.status(200).send({data:{message:\"Activation code is sent to \".concat(n)}}),e.next=26;break;case 22:e.prev=22,e.t1=e.catch(10),N.a.error(\"Error on requesting activation code:\",e.t1),r.status(500).send({errors:[e.t1]});case 26:case\"end\":return e.stop()}}),e,null,[[2,6],[10,22]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/activate\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g,k,b,w,x,E,T,O;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.email,s=n.code,i=n.login_type,o=S.a.object().keys({email:S.a.string().email({minDomainSegments:2}).min(3).max(30).required(),code:S.a.string().min(6).max(10).required(),login_type:S.a.number().required()}),e.prev=2,S.a.assert({email:a,code:s,login_type:i},o,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),u=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:u}));case 10:return e.prev=10,e.next=13,R.User.findOne({where:{email:a}});case 13:if(c=e.sent){e.next=16;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your email isn't registered\"}]}));case 16:if(1==c.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your account is already activated.\"}]}));e.next=20;break;case 20:if(0!=c.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Unable to active this account. Please contact to support.\"}]}));e.next=22;break;case 22:return e.next=24,R.Activation.findOne({where:{user_id:c.id,code:s},order:[[\"create_date\",\"DESC\"]]});case 24:if(l=e.sent){e.next=27;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Activation code is incorrect\"}]}));case 27:return e.next=29,Re(l);case 29:if(e.sent){e.next=32;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Activation data is expired. Please request activation again.\"}]}));case 32:return e.next=34,Ie(c,l);case 34:return Ee.addUser(c.get({plain:!0})),e.next=37,Te(c,h.a.token_expiresin);case 37:return d=e.sent,e.next=40,Te(c,h.a.refresh_token_expiresin);case 40:return p=e.sent,f=c.id,m=c.first_name,_=c.last_name,y=c.photo,g=c.status,k=c.country_code,b=c.phonenumber,w=c.gender,x=c.age_range,E=c.address,T=c.preferences,O=c.cash,e.next=44,R.UserLogin.create({user_id:f,refresh_token:p,login_type:i});case 44:r.status(200).send({data:{user:{id:f,first_name:m,last_name:_,email:a,photo:y,status:g,country_code:k,phonenumber:b,gender:w,age_range:x,address:E,preferences:T,cash:O},token:d,refresh_token:p}}),e.next=51;break;case 47:e.prev=47,e.t1=e.catch(10),N.a.error(\"Error on activate user:\",e.t1),r.status(500).send({errors:[e.t1]});case 51:case\"end\":return e.stop()}}),e,null,[[2,6],[10,47]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/request_reset_password\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body.email,a=S.a.object().keys({email:S.a.string().email({minDomainSegments:2}).min(3).max(30).required()}),e.prev=2,S.a.assert({email:n},a,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),s=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:s}));case 10:return e.prev=10,e.next=13,R.User.findOne({where:{email:n}});case 13:if(i=e.sent){e.next=16;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your email isn't registered\"}]}));case 16:if(0==i.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your account isn't activated. Please activate that first\"}]}));e.next=20;break;case 20:if(1!=i.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your account has a problem. Please contact to support.\"}]}));e.next=22;break;case 22:Ae(i),r.status(200).send({data:{message:\"Reset password email is sent to \".concat(n)}}),e.next=30;break;case 26:e.prev=26,e.t1=e.catch(10),N.a.error(\"Error on requesting reset password:\",e.t1),r.status(500).send({errors:[e.t1]});case 30:case\"end\":return e.stop()}}),e,null,[[2,6],[10,26]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/reset_password\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.email,s=n.code,i=n.password,o=S.a.object().keys({email:S.a.string().email({minDomainSegments:2}).min(3).max(30).required(),code:S.a.string().min(6).max(10).required(),password:S.a.string().min(3).max(30).required()}),e.prev=2,S.a.assert({email:a,code:s,password:i},o,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),u=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:u}));case 10:return e.prev=10,e.next=13,R.User.findOne({where:{email:a}});case 13:if(c=e.sent){e.next=16;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your email isn't registered\"}]}));case 16:if(0==c.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your account isn't activated. Please activate that first\"}]}));e.next=20;break;case 20:if(1!=c.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Your account has a problem. Please contact to support.\"}]}));e.next=22;break;case 22:return e.next=24,R.Activation.findOne({where:{user_id:c.id,code:s},order:[[\"create_date\",\"DESC\"]]});case 24:if(l=e.sent){e.next=27;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Code is incorrect\"}]}));case 27:return e.next=29,Re(l);case 29:if(e.sent){e.next=32;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"Code is expired. Please request again.\"}]}));case 32:return e.next=34,R.User.update({password:i},{where:{id:c.id}});case 34:r.status(200).send({data:{message:\"Password is changed successfully\"}}),e.next=41;break;case 37:e.prev=37,e.t1=e.catch(10),N.a.error(\"Error on reset password:\",e.t1),r.status(500).send({errors:[e.t1]});case 41:case\"end\":return e.stop()}}),e,null,[[2,6],[10,37]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/token\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g,k,b,w,x,E,T;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body.refresh_token,a=S.a.object().keys({refresh_token:S.a.string().required()}),e.prev=2,S.a.assert({refresh_token:n},a,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),s=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:s}));case 10:return e.prev=10,i=z.a.verify(n,h.a.secret_key,{ignoreExpiration:!0}),e.next=14,R.User.findByPk(i.id);case 14:return o=e.sent,e.next=17,R.UserLogin.findOne({where:{user_id:o.id,refresh_token:n}});case 17:if(u=e.sent){e.next=22;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"No account found with this refresh token: \".concat(n)}]}));case 22:if(1<u.status)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"refresh token invalid\"}]}));e.next=24;break;case 24:if(i.exp<=Math.floor(Date.now()/1e3))return e.next=27,u.update({logout:(new Date).toLocaleString(),status:2});e.next=28;break;case 27:return e.abrupt(\"return\",r.status(401).send({errors:[{message:\"refresh token expired\"}]}));case 28:return e.next=30,Te(o,h.a.token_expiresin);case 30:return c=e.sent,e.next=33,Te(o,h.a.refresh_token_expiresin);case 33:return l=e.sent,e.next=36,u.update({refresh_token:l,refresh:(new Date).toLocaleString(),status:1});case 36:d=o.id,p=o.first_name,f=o.last_name,m=o.email,_=o.photo,y=o.status,g=o.country_code,k=o.phonenumber,b=o.gender,w=o.age_range,x=o.address,E=o.preferences,T=o.cash,r.status(200).send({data:{user:{id:d,first_name:p,last_name:f,email:m,photo:_,status:y,country_code:g,phonenumber:k,gender:b,age_range:w,address:x,preferences:E,cash:T},token:c,refresh_token:l}}),e.next=44;break;case 40:e.prev=40,e.t1=e.catch(10),N.a.error(\"Error on update token:\",e.t1),r.status(500).send({errors:[e.t1]});case 44:case\"end\":return e.stop()}}),e,null,[[2,6],[10,40]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/logout\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body.refresh_token,a=S.a.object().keys({refresh_token:S.a.string().required()}),e.prev=2,S.a.assert({refresh_token:n},a,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),s=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:s}));case 10:return e.prev=10,i=t.user.id,e.next=14,R.UserLogin.findOne({where:{user_id:i,refresh_token:n}});case 14:if(o=e.sent){e.next=17;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"No account found with this refresh token: \".concat(n)}]}));case 17:return e.next=19,o.update({status:3});case 19:t.logout(),r.status(200).send({data:\"Success\"}),e.next=27;break;case 23:e.prev=23,e.t1=e.catch(10),N.a.error(\"Error on logout:\",e.t1),r.status(500).send({errors:[e.t1]});case 27:case\"end\":return e.stop()}}),e,null,[[2,6],[10,23]])})));return function(t,r){return e.apply(this,arguments)}}()),Ne.post(\"/social\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g,k,b,w,x,E,T,O,A,I,q,D,j,U;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.type,s=n.social_id,i=n.email,o=n.first_name,n.last_name,n.photo,u=n.login_type,c=S.a.object().keys({type:S.a.number().required(),email:S.a.string().required(),first_name:S.a.string().required(),login_type:S.a.number().required()}),e.prev=2,S.a.assert({type:a,email:i,first_name:o,login_type:u},c,{abortEarly:!1}),e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(2),l=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:l}));case 10:return e.prev=10,d={},e.next=14,R.SocialUser.findOne({where:{type:a,social_id:s}});case 14:if(p=e.sent,f=0,p)return e.next=19,R.User.findOne({where:{id:p.user_id}});e.next=25;break;case 19:if(2<=(d=e.sent).status)return e.abrupt(\"return\",r.status(401).send({errors:[{message:\"This account is blocked, please contact to support.\"}]}));e.next=22;break;case 22:f=d.id,e.next=38;break;case 25:if(x&&0<x.length)return e.next=28,R.User.findOne({where:{email:x}});e.next=30;break;case 28:(m=e.sent)&&(f=(d=m).id);case 30:if(0===f)return e.next=33,R.User.create({first_name:t.body.first_name,last_name:t.body.last_name,password:Math.random().toString(36).slice(-8),email:t.body.email,status:1,photo:t.body.photo||h.a.default_avatar});e.next=36;break;case 33:_=e.sent,d=_.get({plain:!0}),f=d.id;case 36:return e.next=38,R.SocialUser.create({user_id:f,social_id:s,type:a});case 38:return e.next=40,Te(d,h.a.token_expiresin);case 40:return y=e.sent,e.next=43,Te(d,h.a.refresh_token_expiresin);case 43:return g=e.sent,e.next=46,R.UserLogin.create({user_id:f,refresh_token:g,login_type:u});case 46:k=d.id,b=d.first_name,w=d.last_name,x=d.email,E=d.photo,T=d.status,O=d.country_code,A=d.phonenumber,I=d.gender,q=d.age_range,D=d.address,j=d.preferences,U=d.cash,r.status(200).send({data:{user:{id:k,first_name:b,last_name:w,email:x,photo:E,status:T,country_code:O,phonenumber:A,gender:I,age_range:q,address:D,preferences:j,cash:U},token:y,refresh_token:g}}),e.next=54;break;case 50:e.prev=50,e.t1=e.catch(10),N.a.error(\"Error on update token:\",e.t1),r.status(500).send({errors:[e.t1]});case 54:case\"end\":return e.stop()}}),e,null,[[2,6],[10,50]])})));return function(t,r){return e.apply(this,arguments)}}());var Se=Ne,qe=r(22);function De(e,t){var r;if(\"undefined\"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if(\"string\"==typeof e)return je(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return\"Object\"===r&&e.constructor&&(r=e.constructor.name),\"Map\"===r||\"Set\"===r?Array.from(e):\"Arguments\"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?je(e,t):void 0}}(e))||t&&e&&\"number\"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError(\"Invalid attempt to iterate non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.\")}var s,i=!0,o=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){o=!0,s=e},f:function(){try{i||null==r.return||r.return()}finally{if(o)throw s}}}}function je(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Ue=r(42);qe.initializeApp({credential:qe.credential.cert(Ue),databaseURL:h.a.firebase_url});var Pe=new(function(){function e(){U()(this,e)}var t,r,n;return C()(e,[{key:\"sendNotification\",value:(n=y()(v.a.mark((function e(t,r,n){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,qe.messaging().sendMulticast({tokens:t,notification:{title:r,body:n}});case 2:case\"end\":return e.stop()}}),e)}))),function(e,t,r){return n.apply(this,arguments)})},{key:\"sendFollowNotification\",value:(r=y()(v.a.mark((function e(t,r){var n,a,s,i=arguments;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=\"Follow\",a=r+(0===(2<i.length&&void 0!==i[2]?i[2]:0)?\" starts \":\" no longer \")+\"following you\",e.next=5,R.Notification.create({user_id:t,title:n,content:a,read:0});case 5:return e.next=7,R.NotificationToken.findOne({where:{user_id:t}});case 7:(s=e.sent)&&this.sendNotification([s.token],n,a);case 9:case\"end\":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:\"sendEventCreateNotification\",value:(t=y()(v.a.mark((function e(t,r,n){var a,s,i,o,u,c,l,d;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,R.Relation.findAll({nest:!1,raw:!0,where:{user_id:t},attributes:[\"id\"],include:[{model:R.User,as:\"follower\",attributes:[\"id\"],required:!0,include:[{model:R.NotificationToken,as:\"my_notification_token\",attributes:[\"token\"],required:!0}]}]});case 2:if(0===(a=e.sent).length)return e.abrupt(\"return\");e.next=5;break;case 5:s=\"Event\",i=\"\".concat(r,' just created new event \"').concat(n,'\"'),o=[],u=[],c=De(a);try{for(c.s();!(l=c.n()).done;)d=l.value,o.push({user_id:d[\"follower.id\"],title:s,content:i,read:0}),u.push(d[\"follower.my_notification_token.token\"])}catch(e){c.e(e)}finally{c.f()}return e.next=13,R.Notification.bulkCreate(o);case 13:this.sendNotification(u,s,i);case 14:case\"end\":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})}]),e}()),Ce=r(37),Me=r.n(Ce);function Le(e,t){var r,n=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)),n}function Ge(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Le(Object(r),!0).forEach((function(t){E()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Le(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var We=Object(a.Router)(),Ke=k.a.Op,Ve=[\"id\",\"user_id\",\"title\",\"description\",\"content\",\"online_event\",\"location\",\"lat\",\"lng\",\"total_ticket\",\"ticket_limit\",\"poster\",\"start_date\",\"end_date\",\"free_event\",\"price\",\"restriction_age\",\"restriction_dress\",\"restriction_refund\",\"restriction_id\",\"restriction_cash\",\"status\",\"qrcode\",\"createdAt\",\"updatedAt\"],Be=[{model:R.User,as:\"creator\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]},{model:R.Comment,attributes:[\"id\",\"relation_id\",\"text\",\"user_id\",\"createdAt\",\"updatedAt\"],as:\"comments\",required:!1,where:{type:0},include:[{model:R.User,attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"],as:\"user\"}]},{model:R.Reaction,attributes:[\"user_id\"],required:!1,where:{type:0,value:1},as:\"likes\"},{model:R.Reaction,attributes:[\"user_id\"],required:!1,where:{type:0,value:2},as:\"dislikes\"}];We.get(\"/public\",function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,R.Event.findAll({nest:!0,raw:!1,attributes:Ve,include:Be});case 3:n=e.sent,r.status(200).send({data:n}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),N.a.error(\"Error on fetching events:\",e.t0),r.status(500).send({errors:[e.t0]});case 11:case\"end\":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}()),We.get(\"/\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=Ee.findEvents(t.user.id,\"\",null,50),a=n.map((function(e){return e.get(\"id\")})),e.next=5,R.Event.findAll({nest:!0,raw:!1,attributes:Ve,include:Be,where:{id:E()({},Ke.in,a)}});case 5:(s=e.sent).sort((function(e,t){return a.indexOf(e.id)-a.indexOf(t.id)})),r.status(200).send({data:s}),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),N.a.error(\"Error on fetching events:\",e.t0),r.status(500).send({errors:[e.t0]});case 14:case\"end\":return e.stop()}}),e,null,[[0,10]])})));return function(t,r){return e.apply(this,arguments)}}()),We.get(\"/detail/:id\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.params.id,e.next=4,R.Event.findOne({attributes:Ve,include:Be,where:{id:n}});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),N.a.error(\"Error on fetching event:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[0,8]])})));return function(t,r){return e.apply(this,arguments)}}()),We.get(\"/mine\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.user.id,e.next=4,R.Event.findAll({nest:!0,raw:!1,attributes:Ve,include:[].concat(Be,[{model:R.Attend,as:\"attenders\",required:!1}]),where:{user_id:n}});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),N.a.error(\"Error on fetching my events:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[0,8]])})));return function(t,r){return e.apply(this,arguments)}}()),We.post(\"/attend\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body.event_id,a=t.user.id,e.next=5,R.Attend.findOne({where:{user_id:a,event_id:n}});case 5:if(e.sent)return e.abrupt(\"return\",r.status(200).send({data:{msg:\"success\"}}));e.next=8;break;case 8:return e.next=10,R.Ticket.findOne({where:{user_id:a,event_id:n}});case 10:if(e.sent){e.next=13;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"You have no tickets on this event.\"}]}));case 13:return e.next=15,R.Attend.create({user_id:a,event_id:n});case 15:r.status(200).send({data:{msg:\"success\"}}),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(0),N.a.error(\"Error on attending event:\",e.t0),r.status(500).send({errors:[e.t0]});case 22:case\"end\":return e.stop()}}),e,null,[[0,18]])})));return function(t,r){return e.apply(this,arguments)}}()),We.post(\"/\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,h,m,_,y,g,k,b,w,x,T,O,A,I,q,D,j,U,P,C,M;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.title,s=n.description,i=n.content,o=n.online_event,u=n.location,c=n.lat,l=n.lng,d=n.start_date,p=n.end_date,f=n.total_ticket,h=n.ticket_limit,m=n.price,_=n.free_event,y=n.poster,g=n.restriction_age,k=n.restriction_dress,b=n.restriction_refund,w=n.restriction_id,x=n.restriction_cash,T=t.user,O=T.id,A=T.first_name,I=T.last_name,q=S.a.object().keys({title:S.a.string().required(),description:S.a.string().required(),content:S.a.string().required(),online_event:S.a.number().min(0).max(1).required(),location:S.a.string().required(),lat:S.a.number().required(),lng:S.a.number().required(),start_date:S.a.date().required(),end_date:S.a.date().required(),total_ticket:S.a.number().min(1).required(),ticket_limit:S.a.number().min(1).max(50).required(),free_event:S.a.number().min(0).max(1).required(),price:S.a.number().required(),poster:S.a.string().required()}),e.prev=3,S.a.assert(E()({title:a,description:s,content:i,online_event:o,location:u,lat:c,lng:l,start_date:d,end_date:p,total_ticket:f,ticket_limit:h,price:m,poster:y,free_event:_},\"poster\",y),q,{abortEarly:!1}),e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(3),D=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:D}));case 11:return e.prev=11,e.next=14,R.Event.create({user_id:O,title:a,description:s,content:i,online_event:o,poster:y,location:1===o?\"Online Event\":u,lat:c,lng:l,start_date:d,end_date:p,total_ticket:f,ticket_limit:h,free_event:_,price:1===_?0:m,restriction_age:g,restriction_dress:k,restriction_refund:b,restriction_id:w,restriction_cash:x});case 14:return j=e.sent,U=j.get({plain:!0}),P=JSON.stringify({eventree_id:U.id}),e.next=19,Me.a.toDataURL(P,{errorCorrectionLevel:\"L\",width:400,margin:0,scale:1});case 19:return C=e.sent,e.next=22,B.upload64({uri:C,name:\"\"});case 22:return M=e.sent,e.next=25,R.Event.update({qrcode:M.Location},{where:{id:U.id}});case 25:Pe.sendEventCreateNotification(O,\"\".concat(A,\" \").concat(I),a),Ee.addEvent(U),r.status(200).send({data:{event:U}}),e.next=34;break;case 30:e.prev=30,e.t1=e.catch(11),N.a.error(\"Error on creating event:\",e.t1),r.status(500).send({errors:[e.t1]});case 34:case\"end\":return e.stop()}}),e,null,[[3,7],[11,30]])})));return function(t,r){return e.apply(this,arguments)}}()),We.post(\"/search\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body,a=n.search_string,s=n.from,i=n.to,o={start_date:E()({},Ke.ne,null)},a&&0<a.length&&(o.title=E()({},Ke.iLike,\"%\".concat(a,\"%\"))),s&&0<s.length&&(o.start_date=Ge(Ge({},o.start_date),{},E()({},Ke.gte,$()(s).format(\"YYYY-MM-DD HH:mm:ss\")))),i&&0<i.length&&(o.start_date=Ge(Ge({},o.start_date),{},E()({},Ke.lte,$()(i).format(\"YYYY-MM-DD HH:mm:ss\")))),e.next=8,R.Event.findAll({nest:!0,raw:!1,attributes:Ve,include:Be,where:o});case 8:u=e.sent,r.status(200).send({data:u}),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(0),N.a.error(\"Error on fetching events:\",e.t0),r.status(500).send({errors:[e.t0]});case 16:case\"end\":return e.stop()}}),e,null,[[0,12]])})));return function(t,r){return e.apply(this,arguments)}}());var Ye=We,Fe=Object(a.Router)();Fe.post(\"/:comment_id\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,h,m,_,y,g;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.params.comment_id,a=t.body,s=a.relation_id,i=a.type,o=a.text,u=t.user,c=u.id,l=u.photo,d=u.first_name,p=u.last_name,f=S.a.object().keys({relation_id:S.a.number().required(),type:S.a.number().required(),text:S.a.string().required()}),e.prev=4,S.a.assert({relation_id:s,type:i,text:o},f,{abortEarly:!1}),e.next=12;break;case 8:return e.prev=8,e.t0=e.catch(4),h=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:h}));case 12:if(e.prev=12,m={},0===parseInt(n,10))return e.next=17,R.Comment.create({user_id:c,relation_id:s,type:i,text:o});e.next=22;break;case 17:_=e.sent,m=_.get({plain:!0}),Ee.addComment(m),e.next=27;break;case 22:return e.next=24,R.Comment.update({text:o},{where:{id:n}});case 24:return e.next=26,R.Comment.findByPk(n);case 26:m=e.sent;case 27:y=m.createdAt,g=m.updatedAt,r.status(200).send({data:{comment:{id:m.id,relation_id:s,type:i,text:o,createdAt:y,updatedAt:g,user:{id:c,photo:l,first_name:d,last_name:p}}}}),e.next=35;break;case 31:e.prev=31,e.t1=e.catch(12),N.a.error(\"Error on leaving comment:\",e.t1),r.status(500).send({errors:[e.t1]});case 35:case\"end\":return e.stop()}}),e,null,[[4,8],[12,31]])})));return function(t,r){return e.apply(this,arguments)}}()),Fe.post(\"/delete/:comment_id\",function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.comment_id,e.prev=1,e.next=4,R.Comment.destroy({where:{id:n}});case 4:Ee.addComment(comment),r.status(200).send({data:{msg:\"success\"}}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),N.a.error(\"Error on deleting comment:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}());var He=Fe;function Je(e,t){var r,n=Object.keys(e);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(e),t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)),n}function Xe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Je(Object(r),!0).forEach((function(t){E()(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Je(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var ze=Object(a.Router)();ze.post(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,h,m;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.relation_id,s=n.type,i=n.value,o=t.user.id,u=S.a.object().keys({relation_id:S.a.number().required(),type:S.a.number().required(),value:S.a.number().min(1).required()}),e.prev=3,S.a.assert({relation_id:a,type:s,value:i},u,{abortEarly:!1}),e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(3),c=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:c}));case 11:return e.prev=11,e.next=14,R.Reaction.findOne({where:{relation_id:a,type:s,user_id:o}});case 14:if(l=e.sent)return i=l.value!=i?i:0,e.next=19,R.Reaction.update({value:i},{where:{id:l.id}});e.next=22;break;case 19:Ee.updateLike(Xe(Xe({},l.get({plain:!0})),{},{value:i})),e.next=26;break;case 22:return e.next=24,R.Reaction.create({relation_id:a,type:s,user_id:o,value:i});case 24:d=e.sent,Ee.addLike(d.get({plain:!0}));case 26:return p={},0==s&&(p=R.Event),e.next=30,p.findOne({nest:!0,raw:!1,include:[{model:R.Reaction,attributes:[\"user_id\"],required:!1,where:{type:s,value:1},as:\"likes\"},{model:R.Reaction,attributes:[\"user_id\"],required:!1,where:{type:s,value:2},as:\"dislikes\"}],where:{id:a}});case 30:f=e.sent,h=f.likes,m=f.dislikes,r.status(200).send({data:{value:i,type:s,relation_id:a,likes:h,dislikes:m}}),e.next=39;break;case 35:e.prev=35,e.t1=e.catch(11),N.a.error(\"Error on making reaction:\",e.t1),r.status(500).send({errors:[e.t1]});case 39:case\"end\":return e.stop()}}),e,null,[[3,7],[11,35]])})));return function(t,r){return e.apply(this,arguments)}}());var Qe=ze,Ze=Object(a.Router)();Ze.post(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,h,m;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.first_name,s=n.last_name,i=n.photo,o=n.address,u=n.country_code,c=n.phonenumber,l=n.gender,d=n.age_range,p=n.preferences,f=t.user.id,h=S.a.object().keys({first_name:S.a.string().required(),last_name:S.a.string().required(),photo:S.a.string().uri({allowRelative:!0}).allow(\"\",null),address:S.a.string().allow(\"\",null),country_code:S.a.string().max(3).required(),phonenumber:S.a.string().max(20).allow(\"\",null),gender:S.a.number().min(0).max(1).required(),age_range:S.a.number().min(0).max(3).required(),preferences:S.a.string().allow(\"\",null)}),e.prev=3,S.a.assert({first_name:a,last_name:s,photo:i,address:o,country_code:u,phonenumber:c,gender:l,age_range:d,preferences:p},h,{abortEarly:!1}),e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(3),m=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:m}));case 11:return e.prev=11,e.next=14,R.User.update({first_name:a,last_name:s,photo:i,address:o||\"\",country_code:u,phonenumber:c||\"\",gender:l,age_range:d,preferences:p||\"\"},{where:{id:f}});case 14:r.status(200).send({data:{msg:\"Success\"}}),e.next=21;break;case 17:e.prev=17,e.t1=e.catch(11),N.a.error(\"Error on updating user:\",e.t1),r.status(500).send({errors:[e.t1]});case 21:case\"end\":return e.stop()}}),e,null,[[3,7],[11,17]])})));return function(t,r){return e.apply(this,arguments)}}());var $e=Ze,et=r(38),tt=r.n(et),rt=r(10),nt=r(17),at=r.n(nt),st=rt.format.combine,it=rt.format.timestamp,ot=rt.format.label,ut=rt.format.simple,ct=rt.format.printf,lt=rt.format.colorize;W.a.existsSync(\"logs\")||W.a.mkdirSync(\"logs\");var dt=Object(rt.createLogger)({level:\"info\",format:st(ot({label:h.a.app_name}),it({format:\"YYYY-MM-DD HH:mm:ss\"}),ut(),ct((function(e){var t=e.padding&&e.padding[e.level]||\"\";return\"\".concat(e.timestamp,\" [\").concat(e.label,\"] \").concat(e.level,\":\").concat(t,\" \").concat(e.message)})),lt()),transports:[new at.a({filename:\"logs/stripe.log\"})]}),pt=new(function(){function e(){U()(this,e),this.stripe=new tt.a(h.a.stripe_key)}var t,r,n,a,s,i,o,u,c,l,d;return C()(e,[{key:\"createPaymentIntent\",value:(d=y()(v.a.mark((function e(t,r,n){var a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.stripe.paymentIntents.create({amount:t,currency:r,customer:n});case 2:return a=e.sent,e.abrupt(\"return\",a);case 4:case\"end\":return e.stop()}}),e,this)}))),function(e,t,r){return d.apply(this,arguments)})},{key:\"createCharge\",value:(l=y()(v.a.mark((function e(t,r,n){var a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(\"TOKEN\",n),e.next=3,this.stripe.charges.create({amount:t,currency:r,source:n,description:\"Charge\"});case 3:return a=e.sent,e.abrupt(\"return\",a);case 5:case\"end\":return e.stop()}}),e,this)}))),function(e,t,r){return l.apply(this,arguments)})},{key:\"getPaymentMethod\",value:(c=y()(v.a.mark((function e(t){var r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.paymentMethods.retrieve(t);case 3:r=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on getting stripe payment method:\",e.t0);case 9:return e.abrupt(\"return\",r);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e){return c.apply(this,arguments)})},{key:\"attachPaymentMethod\",value:(u=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.paymentMethods.attach(t,{customer:r});case 3:n=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on attach stripe payment method to customer:\",e.t0);case 9:return e.abrupt(\"return\",n);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e,t){return u.apply(this,arguments)})},{key:\"getToken\",value:(o=y()(v.a.mark((function e(t){var r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.tokens.retrieve(t);case 3:r=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on getting stripe token:\",e.t0);case 9:return e.abrupt(\"return\",r);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e){return o.apply(this,arguments)})},{key:\"createCustomer\",value:(i=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.customers.create({name:t,email:r});case 3:n=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on creating stripe customer:\",e.t0);case 9:return e.abrupt(\"return\",n);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e,t){return i.apply(this,arguments)})},{key:\"createCustomerWithPaymentMethod\",value:(s=y()(v.a.mark((function e(t,r,n){var a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.customers.create({payment_method:t,name:r,email:n,invoice_settings:{default_payment_method:t}});case 3:a=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on creating stripe customer:\",e.t0);case 9:return e.abrupt(\"return\",a);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e,t,r){return s.apply(this,arguments)})},{key:\"createCustomerWithToken\",value:(a=y()(v.a.mark((function e(t,r,n){var a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.customers.create({name:r,email:n,source:t});case 3:a=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on creating stripe customer:\",e.t0);case 9:return e.abrupt(\"return\",a);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e,t,r){return a.apply(this,arguments)})},{key:\"getCustomer\",value:(n=y()(v.a.mark((function e(t){var r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.stripe.customers.retrieve(t);case 3:r=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),dt.error(\"error on getting stripe customer:\",e.t0);case 9:return e.abrupt(\"return\",r);case 10:case\"end\":return e.stop()}}),e,this,[[0,6]])}))),function(e){return n.apply(this,arguments)})},{key:\"getCustomerDefaultSource\",value:(r=y()(v.a.mark((function e(t){var r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t&&t.default_source)return e.next=4,this.stripe.customers.retrieveSource(t.id,t.default_source);e.next=5;break;case 4:r=e.sent;case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),dt.error(\"error on getting stripe customer default source:\",e.t0);case 10:return e.abrupt(\"return\",r);case 11:case\"end\":return e.stop()}}),e,this,[[0,7]])}))),function(e){return r.apply(this,arguments)})},{key:\"updateCustomer\",value:(t=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=!1,e.prev=1,e.next=4,this.stripe.customers.update(t,r);case 4:n=e.sent,e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),dt.error(\"error on updating stripe customer:\",e.t0);case 10:return e.abrupt(\"return\",n);case 11:case\"end\":return e.stop()}}),e,this,[[1,7]])}))),function(e,r){return t.apply(this,arguments)})}]),e}()),ft=Object(a.Router)(),ht=(k.a.Op,[\"id\",\"event_id\",\"user_id\",\"amount\",\"price\",\"status\",\"createdAt\",\"updatedAt\"]),mt=[{model:R.Event,attributes:[\"id\",\"title\",\"start_date\",\"end_date\",\"location\"],as:\"eventinfo\",required:!1,include:[{model:R.User,as:\"creator\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]}]},{model:R.User,as:\"owner\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]}];ft.get(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,e.prev=1,e.next=4,R.Ticket.findAll({nest:!0,raw:!1,attributes:ht,include:mt,where:{status:0,user_id:n}});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),N.a.error(\"Error on fetching tickets:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()),ft.post(\"/checkTicketLimit\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,h;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,a=t.body,s=a.event_id,i=a.amount,e.prev=2,e.next=5,R.Event.findByPk(s);case 5:return o=e.sent,u=o.total_ticket,c=o.ticket_limit,e.next=9,R.TicketPurchase.findAll({attributes:[[k.a.fn(\"sum\",k.a.col(\"amount\")),\"total_amount\"]],where:{event_id:s}});case 9:if(l=e.sent,(d=u-parseInt(l||0,10))<i)return e.abrupt(\"return\",r.status(403).send({errors:[{message:d<=0?\"No more tickets left on this event.\":\"\".concat(d,\" tickets are remaining.\")}]}));e.next=13;break;case 13:return e.next=15,R.TicketPurchase.findOne({where:{user_id:n,event_id:s}});case 15:if(p=e.sent,f=p?p.amount:0,c<f+i)return h=c-f,e.abrupt(\"return\",r.status(403).send({errors:[{message:h<=0?\"You can't buy any more tickets on this event.\":\"You can buy only \".concat(h,\" tickets.\")}]}));e.next=20;break;case 20:r.status(200).send({data:{msg:\"success\"}}),e.next=27;break;case 23:e.prev=23,e.t0=e.catch(2),N.a.error(\"Error on checking limit:\",e.t0),r.status(500).send({errors:[e.t0]});case 27:case\"end\":return e.stop()}}),e,null,[[2,23]])})));return function(t,r){return e.apply(this,arguments)}}()),ft.post(\"/buyOnEvent\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g,k;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user,a=n.id,s=n.first_name,i=n.last_name,o=t.body,u=o.token,c=o.event_id,l=o.amount,e.prev=2,e.next=5,R.Event.findByPk(c);case 5:if(d=e.sent,p=d.price,f=d.user_id,m=d.title,0!==d.free_event){e.next=24;break}if(_=p*l*(100+h.a.service_fee),u)return e.next=12,pt.createCharge(_,\"usd\",u);e.next=15;break;case 12:if(e.sent){e.next=15;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"There's a problem on checkout.\"}]}));case 15:return e.next=17,R.PaymentHistory.create({user_id:a,amount:(_/100).toFixed(2),type:1,related_user_id:f,description:\"Buy \".concat(l,\" tickets on event - \").concat(m)});case 17:return e.next=19,R.PaymentHistory.create({user_id:f,amount:(p*l).toFixed(2),type:0,related_user_id:a,description:\"User \".concat(s,\" \").concat(i,\" bought \").concat(l,\" tickets on event - \").concat(m)});case 19:return e.next=21,R.User.findByPk(f);case 21:return y=e.sent,e.next=24,R.User.update({cash:(y.cash+p*l).toFixed(2)},{where:{id:f}});case 24:return e.next=26,R.TicketPurchase.findOne({where:{user_id:a,event_id:c}});case 26:if(g=e.sent){e.next=32;break}return e.next=30,R.TicketPurchase.create({event_id:c,user_id:a,amount:l});case 30:e.next=34;break;case 32:return e.next=34,R.TicketPurchase.update({amount:g.amount+l},{where:{id:g.id}});case 34:return e.next=36,R.Ticket.findOne({where:{user_id:a,event_id:c}});case 36:if(k=e.sent){e.next=42;break}return e.next=40,R.Ticket.create({event_id:c,user_id:a,amount:l,price:p,status:0});case 40:e.next=44;break;case 42:return e.next=44,R.Ticket.update({amount:k.amount+l,price:p},{where:{id:k.id}});case 44:r.status(200).send({data:{}}),e.next=51;break;case 47:e.prev=47,e.t0=e.catch(2),N.a.error(\"Error on buying tickets:\",e.t0),r.status(500).send({errors:[e.t0]});case 51:case\"end\":return e.stop()}}),e,null,[[2,47]])})));return function(t,r){return e.apply(this,arguments)}}()),ft.post(\"/sendToFriend\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,a=t.body,s=a.ticket_id,i=a.amount,o=a.friend_id,e.prev=2,e.next=5,R.Ticket.findByPk(s);case 5:return u=e.sent,e.next=8,R.Market.findOne({where:{user_id:n,ticket_id:s}});case 8:if(c=e.sent,l=c?c.amount:0,(d=u.amount-l)<i)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"You can send only \".concat(d,\" tickets.\")}]}));e.next=13;break;case 13:if(u.amount===i)return e.next=16,R.Ticket.destroy({where:{id:u.id}});e.next=18;break;case 16:e.next=20;break;case 18:return e.next=20,R.Ticket.update({amount:u.amount-i},{where:{id:u.id}});case 20:return e.next=22,R.Ticket.findOne({where:{id:s,user_id:o}});case 22:if(p=e.sent)return e.next=26,R.Ticket.update({amount:p.amount+i},{where:{id:p.id}});e.next=28;break;case 26:e.next=30;break;case 28:return e.next=30,R.Ticket.create({user_id:o,amount:i,price:u.price,event_id:u.event_id});case 30:r.status(200).send({data:{}}),e.next=37;break;case 33:e.prev=33,e.t0=e.catch(2),N.a.error(\"Error on sending to friend:\",e.t0),r.status(500).send({errors:[e.t0]});case 37:case\"end\":return e.stop()}}),e,null,[[2,33]])})));return function(t,r){return e.apply(this,arguments)}}()),ft.post(\"/buyOnMarket\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f,m,_,y,g;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user,a=n.id,s=n.first_name,i=n.last_name,o=t.body,u=o.token,c=o.market_id,l=o.amount,e.prev=2,e.next=5,R.Market.findByPk(c);case 5:if(d=e.sent,l>d.amount)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"You can buy only \".concat(d.amount,\" tickets\")}]}));e.next=8;break;case 8:return p=d.price,f=d.user_id,e.next=11,R.User.findByPk(f);case 11:if(m=e.sent,_=p*l*(100+h.a.service_fee),u)return e.next=16,pt.createCharge(_,\"usd\",u);e.next=19;break;case 16:if(e.sent){e.next=19;break}return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"There's a problem on checkout.\"}]}));case 19:return e.next=21,R.PaymentHistory.create({user_id:a,amount:(_/100).toFixed(2),type:1,related_user_id:f,description:\"Buy \".concat(l,\" tickets on Market from \").concat(m.first_name,\" \").concat(m.last_name)});case 21:return e.next=23,R.PaymentHistory.create({user_id:f,amount:(p*l).toFixed(2),type:0,related_user_id:a,description:\"User \".concat(s,\" \").concat(i,\" bought \").concat(l,\" tickets on Market\")});case 23:return e.next=25,R.User.update({cash:(m.cash+p*l).toFixed(2)},{where:{id:f}});case 25:if(l===d.amount)return e.next=28,R.Market.destroy({where:{id:c}});e.next=30;break;case 28:e.next=32;break;case 30:return e.next=32,R.Market.update({amount:d.amount-l},{where:{id:c}});case 32:return e.next=34,R.Ticket.findOne({where:{id:d.ticket_id}});case 34:if(y=e.sent,l===y.amount)return e.next=38,R.Ticket.destroy({where:{id:y.id}});e.next=40;break;case 38:e.next=42;break;case 40:return e.next=42,R.Market.update({amount:y.amount-l},{where:{id:d.ticket_id}});case 42:return e.next=44,R.Ticket.findOne({where:{user_id:a,event_id:y.event_id}});case 44:if(g=e.sent){e.next=50;break}return e.next=48,R.Ticket.create({event_id:y.event_id,user_id:a,amount:l,price:p,status:0});case 48:e.next=52;break;case 50:return e.next=52,R.Ticket.update({amount:g.amount+l,price:p},{where:{id:g.id}});case 52:r.status(200).send({data:{}}),e.next=59;break;case 55:e.prev=55,e.t0=e.catch(2),N.a.error(\"Error on buying tickets:\",e.t0),r.status(500).send({errors:[e.t0]});case 59:case\"end\":return e.stop()}}),e,null,[[2,55]])})));return function(t,r){return e.apply(this,arguments)}}()),ft.post(\"/delete/:ticket_id\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,a=t.params.ticket_id,e.prev=2,e.next=5,R.Ticket.destroy({where:{id:a}});case 5:return e.next=7,R.Market.destroy({where:{user_id:n,ticket_id:a}});case 7:r.status(200).send({data:{msg:\"success\"}}),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),N.a.error(\"Error on deleting market:\",e.t0),r.status(500).send({errors:[e.t0]});case 14:case\"end\":return e.stop()}}),e,null,[[2,10]])})));return function(t,r){return e.apply(this,arguments)}}());var vt=ft,_t=Object(a.Router)(),yt=(k.a.Op,[\"id\",\"user_id\",\"related_user_id\",\"amount\",\"type\",\"description\",\"createdAt\",\"updatedAt\"]),gt=[{model:R.User,as:\"related_user\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]}];_t.get(\"/history\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,e.prev=1,e.next=4,R.PaymentHistory.findAll({nest:!0,raw:!1,attributes:yt,include:gt,where:{user_id:n},order:[[\"id\",\"DESC\"]]});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),N.a.error(\"Error on fetching payment history:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()),_t.get(\"/cash\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,e.prev=1,e.next=4,R.User.findByPk(n);case 4:a=e.sent,r.status(200).send({data:{cash:a.cash}}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),N.a.error(\"Error on gettinc user cash:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}());var kt=_t,bt=Object(a.Router)(),wt=function(){var e=y()(v.a.mark((function e(t){var r,n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,R.Relation.findAll({nest:!0,raw:!1,where:{user_id:t},attributes:[\"createdAt\",\"updatedAt\"],include:[{model:R.User,as:\"follower\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]}]});case 2:return r=e.sent,e.next=5,R.Relation.findAll({nest:!0,raw:!1,where:{follower_id:t},attributes:[\"createdAt\",\"updatedAt\"],include:[{model:R.User,as:\"user_info\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]}]});case 5:return n=e.sent,e.abrupt(\"return\",{followers:r,following:n});case 7:case\"end\":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}();bt.get(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,e.prev=1,e.next=4,wt(n);case 4:a=e.sent,s=a.followers,i=a.following,r.status(200).send({data:{followers:s,following:i}}),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),N.a.error(\"Error on getting relation:\",e.t0),r.status(500).send({errors:[e.t0]});case 13:case\"end\":return e.stop()}}),e,null,[[1,9]])})));return function(t,r){return e.apply(this,arguments)}}()),bt.post(\"/follow/:user_id\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.user_id,a=t.user,s=a.id,i=a.first_name,o=a.last_name,e.prev=2,e.next=5,R.Relation.findOne({where:{user_id:parseInt(n,10),follower_id:s}});case 5:if(u=e.sent,c=0,u)return c=1,e.next=11,R.Relation.destroy({where:{id:u.id}});e.next=14;break;case 11:Ee.unfollowUser(u.get({plain:!0})),e.next=18;break;case 14:return e.next=16,R.Relation.create({user_id:parseInt(n,10),follower_id:s});case 16:u=e.sent,Ee.followUser(u.get({plain:!0}));case 18:return Pe.sendFollowNotification(n,\"\".concat(i,\" \").concat(o),c),e.next=21,wt(s);case 21:l=e.sent,d=l.followers,p=l.following,r.status(200).send({data:{followers:d,following:p}}),e.next=30;break;case 26:e.prev=26,e.t0=e.catch(2),N.a.error(\"Error on following:\",e.t0),r.status(500).send({errors:[e.t0]});case 30:case\"end\":return e.stop()}}),e,null,[[2,26]])})));return function(t,r){return e.apply(this,arguments)}}());var xt=bt,Et=Object(a.Router)(),Nt=[\"id\",\"user_id\",\"ticket_id\",\"amount\",\"price\",\"create_date\",\"update_date\"],Tt=[{model:R.User,as:\"owner\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]},{model:R.Ticket,as:\"ticket_info\",include:[{model:R.Event,attributes:[\"id\",\"title\",\"start_date\"],as:\"eventinfo\",required:!1,include:[{model:R.User,as:\"creator\",attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"]}]}]}];Et.post(\"/transfer\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d,p,f;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.user.id,a=t.body,s=a.amount,i=a.ticket_id,o=a.price,u=S.a.object().keys({amount:S.a.number().required(),ticket_id:S.a.number().required(),price:S.a.number().required()}),e.prev=3,S.a.assert({amount:s,ticket_id:i,price:o},u,{abortEarly:!1}),e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(3),c=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:c}));case 11:return e.prev=11,e.next=14,R.Ticket.findByPk(i);case 14:return l=e.sent,e.next=17,R.Market.findOne({where:{user_id:n,ticket_id:i}});case 17:if(d=e.sent,p=d?d.amount:0,(f=l.amount-p)<s)return e.abrupt(\"return\",r.status(403).send({errors:[{message:\"You can transfer \".concat(f,\" tickets.\")}]}));e.next=22;break;case 22:if(d)return e.next=25,R.Market.update({amount:s+d.amount,price:o.toFixed(2)},{where:{id:d.id}});e.next=27;break;case 25:e.next=29;break;case 27:return e.next=29,R.Market.create({amount:s,price:o.toFixed(2),ticket_id:i,user_id:n});case 29:r.status(200).send({data:{msg:\"success\"}}),e.next=36;break;case 32:e.prev=32,e.t1=e.catch(11),N.a.error(\"Error on transfering to market:\",e.t1),r.status(500).send({errors:[e.t1]});case 36:case\"end\":return e.stop()}}),e,null,[[3,7],[11,32]])})));return function(t,r){return e.apply(this,arguments)}}()),Et.post(\"/delete/:market_id\",function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.market_id,e.prev=1,e.next=4,R.Market.destroy({where:{id:n}});case 4:r.status(200).send({data:{msg:\"success\"}}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),N.a.error(\"Error on deleting market:\",e.t0),r.status(500).send({errors:[e.t0]});case 11:case\"end\":return e.stop()}}),e,null,[[1,7]])})));return function(t,r){return e.apply(this,arguments)}}()),Et.get(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,R.Market.findAll({nest:!0,raw:!1,attributes:Nt,include:Tt});case 3:n=e.sent,r.status(200).send({data:n}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),N.a.error(\"Error on fetching market tickets:\",e.t0),r.status(500).send({errors:[e.t0]});case 11:case\"end\":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}());var Ot=Et,At=Object(a.Router)();At.get(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,e.prev=1,e.next=4,R.Notification.findAll({nest:!0,raw:!1,where:{user_id:n},order:[[\"id\",\"DESC\"]]});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),N.a.error(\"Error on getting notifications:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[1,8]])})));return function(t,r){return e.apply(this,arguments)}}()),At.post(\"/read/:notification_id\",function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.params.notification_id,e.prev=1,e.next=4,R.Notification.update({read:1},{where:{id:parseInt(n,10)}});case 4:r.status(200).send({data:{msg:\"success\"}}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),N.a.error(\"Error on reading notification:\",e.t0),r.status(500).send({errors:[e.t0]});case 11:case\"end\":return e.stop()}}),e,null,[[1,7]])})));return function(t,r){return e.apply(this,arguments)}}()),At.post(\"/token\",function(){var e=y()(v.a.mark((function e(t,r){var n,a,s;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.user.id,a=t.body.token,e.prev=2,e.next=5,R.NotificationToken.findOne({where:{user_id:n}});case 5:if(s=e.sent){e.next=11;break}return e.next=9,R.NotificationToken.create({user_id:n,token:a});case 9:e.next=13;break;case 11:return e.next=13,R.NotificationToken.update({token:a},{where:{id:s.id}});case 13:r.status(200).send({data:{msg:\"success\"}}),e.next=20;break;case 16:e.prev=16,e.t0=e.catch(2),N.a.error(\"Error on updating notification token:\",e.t0),r.status(500).send({errors:[e.t0]});case 20:case\"end\":return e.stop()}}),e,null,[[2,16]])})));return function(t,r){return e.apply(this,arguments)}}());var Rt=At,It=Object(a.Router)(),St=k.a.Op,qt=[\"id\",\"first_name\",\"last_name\",\"photo\"],Dt=[{model:R.Relation,as:\"followers\",attributes:[\"user_id\"]}];It.post(\"/search\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.body.search_string,e.next=4,R.User.findAll({nest:!0,raw:!1,attributes:qt,include:Dt,where:k.a.where(k.a.fn(\"concat\",k.a.col(\"first_name\"),k.a.col(\"last_name\")),E()({},St.iLike,\"%\".concat(n,\"%\")))});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),N.a.error(\"Error on fetching users:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[0,8]])})));return function(t,r){return e.apply(this,arguments)}}());var jt=It,Ut=Object(a.Router)(),Pt=(k.a.Op,[\"id\",\"user_id\",\"title\",\"content\",\"poster\",\"createdAt\",\"updatedAt\"]),Ct=[{model:R.Comment,attributes:[\"id\",\"relation_id\",\"text\",\"user_id\",\"createdAt\",\"updatedAt\"],as:\"comments\",required:!1,where:{type:1},include:[{model:R.User,attributes:[\"id\",\"first_name\",\"last_name\",\"photo\"],as:\"user\"}]}];Ut.get(\"/\",function(){var e=y()(v.a.mark((function e(t,r){var n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,R.Community.findAll({nest:!0,raw:!1,attributes:Pt,include:Ct});case 3:n=e.sent,r.status(200).send({data:n}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),N.a.error(\"Error on fetching communities:\",e.t0),r.status(500).send({errors:[e.t0]});case 11:case\"end\":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}()),Ut.get(\"/:id\",function(){var e=y()(v.a.mark((function e(t,r){var n,a;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.params.id,e.next=4,R.Community.findOne({attributes:Pt,include:Ct,where:{id:n}});case 4:a=e.sent,r.status(200).send({data:a}),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),N.a.error(\"Error on fetching community:\",e.t0),r.status(500).send({errors:[e.t0]});case 12:case\"end\":return e.stop()}}),e,null,[[0,8]])})));return function(t,r){return e.apply(this,arguments)}}()),Ut.post(\"/\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),function(){var e=y()(v.a.mark((function e(t,r){var n,a,s,i,o,u,c,l,d;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.body,a=n.title,s=n.content,i=n.poster,o=t.user.id,u=S.a.object().keys({title:S.a.string().required(),content:S.a.string().required(),poster:S.a.string().required()}),e.prev=3,S.a.assert({title:a,content:s,poster:i},u,{abortEarly:!1}),e.next=11;break;case 7:return e.prev=7,e.t0=e.catch(3),c=e.t0.details.map((function(e){return{message:e.message}})),e.abrupt(\"return\",r.status(403).send({errors:c}));case 11:return e.prev=11,e.next=14,R.Community.create({user_id:o,title:a,content:s,poster:i});case 14:l=e.sent,d=l.get({plain:!0}),r.status(200).send({data:{community:d}}),e.next=23;break;case 19:e.prev=19,e.t1=e.catch(11),N.a.error(\"Error on creating community:\",e.t1),r.status(500).send({errors:[e.t1]});case 23:case\"end\":return e.stop()}}),e,null,[[3,7],[11,19]])})));return function(t,r){return e.apply(this,arguments)}}());var Mt=Ut,Lt=r(39),Gt=r(26),Wt=J.a.initialize();J.a.use(\"local\",new Lt.Strategy({usernameField:\"email\",passwordField:\"password\"},(function(e,t,r){return R.User.findByLogin(e).then((function(e){return e?void e.validatePassword(t).then((function(t){return t?void r(null,e,{message:\"Logged In Successfully\"}):r({status:401,message:\"Incorrect email or password.\"},!1)})).catch((function(e){return r(e)})):r({status:401,message:\"Incorrect email or password.\"},!1)})).catch((function(e){return r(e)}))})));var Kt={jwtFromRequest:Gt.ExtractJwt.fromAuthHeaderAsBearerToken(),secretOrKey:h.a.secret_key,ignoreExpiration:!0};J.a.use(\"jwt\",new Gt.Strategy(Kt,(function(e,t){R.User.findOne({where:{email:e.email}}).then((function(e){return t(null,e||!1)})).catch((function(e){if(e)return t(e,!1)}))}))),J.a.serializeUser((function(e,t){t(null,e.id)})),J.a.deserializeUser((function(e,t){R.User.findByPk(e).then((function(e){return t(null,e||!1)})).catch((function(e){if(e)return t(e,!1)}))}));var Vt,Bt,Yt=Wt,Ft=s()();Ft.use(d()()),Ft.use(c.a.json({limit:\"100mb\"})),Ft.use(c.a.urlencoded({extended:!0,limit:\"100mb\"})),Ft.use(f()()),Ft.use(Yt),(Vt=Ft).use(\"/media\",F),(Bt=Vt).use(\"/auth\",Se),Bt.use(\"/event\",Ye),Bt.use(\"/community\",Mt),Bt.use(\"/comment\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),He),Bt.use(\"/reaction\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),Qe),Bt.use(\"/profile\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),$e),Bt.use(\"/ticket\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),vt),Bt.use(\"/payment\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),kt),Bt.use(\"/relation\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),xt),Bt.use(\"/market\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),Ot),Bt.use(\"/notification\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),Rt),Bt.use(\"/user\",J.a.authenticate(\"jwt\",{failWithError:!0,session:!1}),jt),Vt.use((function(e,t,r){var n=new Error(\"Not Found\");n.status=404,r(n)})),Vt.use((function(e,t,r,n){N.a.error(\"API response error:\",e),r.status(e.status||500),r.json({errors:[\"development\"==h.a.env_mode?e:{message:e.message||\"Internal Server Error\"}]})}));var Ht=o.a.createServer(Ft);O.sync({force:!1}).then((function(){N.a.info(\"Connected to database\"),Ee.init(),Ht.listen({port:h.a.port},(function(){return N.a.info(\" Server ready at: http\".concat(h.a.ssl?\"s\":\"\",\"://\").concat(h.a.hostname,\":\").concat(h.a.port))}))}))}]);","extractedComments":[]}